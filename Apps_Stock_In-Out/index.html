<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Stok In-Out</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* All CSS remains the same */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #1a1a2e; color: #eee; overflow-x: hidden; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: #16213e; position: fixed; height: 100vh; overflow-y: auto; z-index: 1000; transition: left 0.3s; left: 0;}
        .main-content { position: relative; flex: 1; margin-left: 250px; padding: 120px 20px 20px 20px; transition: margin-left 0.3s; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: #16213e; padding: 15px 20px; border-radius: 10px; flex-wrap: wrap; gap: 10px; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .logo { padding: 20px; border-bottom: 1px solid #0f3460; display: flex; align-items: center; gap: 10px; }
        .menu { list-style: none; }
        .menu li { padding: 15px 20px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .menu li:hover, .menu li.active { background: #0f3460; border-left: 4px solid #e94560; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #16213e; padding: 20px; border-radius: 10px; display: flex; align-items: center; gap: 15px; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-card.danger { border-left: 4px solid #e94560; }
        .stat-icon { width: 80px; height: 80px; min-width: 80px; position: relative; }
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-card { background: #16213e; padding: 20px; border-radius: 10px; min-height: 350px; display: flex; flex-direction: column; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .chart-wrapper { flex: 1; position: relative; width: 100%; min-height: 300px; }
        .form-card, .transaction-card { background: #16213e; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .transaction-card h3 { display: flex; justify-content: space-between; align-items: center; }
        .form-card h3 { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #0f3460; }
        th { background: #0f3460; color: #fff; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        tr:hover { background: rgba(255,255,255,0.05); }
        .form-container { display: grid; grid-template-columns: 1fr 280px; gap: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        input, select, textarea { width: 100%; padding: 10px; background: #0f3460; border: 1px solid #2a4158; color: #eee; border-radius: 5px; margin-bottom: 15px; }
        input:focus, select:focus, textarea:focus { border-color: #e94560; outline: none; }
        input:read-only, select:disabled, textarea:read-only { background: #2a4158; cursor: not-allowed; opacity: 0.7; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 14px; }
        .required::after { content: ' *'; color: #e94560; }
        button { cursor: pointer; border: none; border-radius: 5px; padding: 8px 15px; transition: 0.3s; }
        button:hover { opacity: 0.85; transform: scale(1.02); }
        .btn-blue { background: #007bff; color: white; } .btn-red { background: #e94560; color: white; } .btn-green { background: #28a745; color: white; } .btn-yellow { background: #ffc107; color: #333; } .btn-orange { background: #fd7e14; color: white; } .btn-purple { background: #6f42c1; color: white; } .btn-cyan { background: #17a2b8; color: white; }
        .btn-submit { width: 100%; padding: 12px; background: #e94560; color: white; font-size: 16px; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        #loginPage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a2e; display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-card { background: #16213e; padding: 40px; width: 90%; max-width: 400px; border-radius: 15px; text-align: center; }
        .page-content { display: none; } .page-content.active { display: block; animation: fade 0.3s; } @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
        .status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-badge.habis { background: #e94560; color: white; animation: blink 1.5s infinite; } .status-badge.kritis { background: #fd7e14; color: white; } .status-badge.menipis { background: #ffc107; color: #333; } .status-badge.aman { background: #28a745; color: white; } @keyframes blink { 0%, 50%, 100% { opacity: 1; } 25%, 75% { opacity: 0.5; } }
        .period-card { background: #16213e; border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #6f42c1; }
        .period-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; } .period-header h3 { display: flex; align-items: center; gap: 10px; margin: 0; }
        .period-selector { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; } .period-selector select, .period-selector input { margin: 0; width: auto; min-width: 100px; }
        .period-info { background: #0f3460; padding: 10px 15px; border-radius: 8px; display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; } .period-info-item { display: flex; align-items: center; gap: 8px; } .period-info-item i { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 12px; } .period-info-item.total i { background: #007bff; } .period-info-item.masuk i { background: #28a745; } .period-info-item.keluar i { background: #e94560; }
        .change-indicator { display: inline-flex; align-items: center; gap: 3px; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; } .change-indicator.up { background: rgba(40, 167, 69, 0.2); color: #28a745; } .change-indicator.down { background: rgba(233, 69, 96, 0.2); color: #e94560; } .change-indicator.same { background: rgba(108, 117, 125, 0.2); color: #6c757d; } .change-indicator.new { background: rgba(111, 66, 193, 0.2); color: #6f42c1; }
        .period-nav { display: flex; gap: 5px; } .period-nav button { padding: 5px 10px; background: #0f3460; color: #aaa; } .period-nav button:hover { background: #2a4158; color: #fff; }
        .table-container { max-height: 400px; overflow-y: auto; border-radius: 8px; border: 1px solid #0f3460; } .table-container::-webkit-scrollbar { width: 8px; } .table-container::-webkit-scrollbar-track { background: #0f3460; } .table-container::-webkit-scrollbar-thumb { background: #2a4158; border-radius: 4px; }
        .order-table-card { background: #16213e; border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #e94560; } .order-table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; } .order-table-header h2 { display: flex; align-items: center; gap: 10px; } .order-table-header h2 .badge-count { background: #e94560; color: white; padding: 3px 10px; border-radius: 20px; font-size: 14px; }
        .filter-buttons { display: flex; gap: 5px; flex-wrap: wrap; } .filter-buttons button.active { box-shadow: 0 0 0 2px #fff; }
        .progress-bar { width: 100%; height: 8px; background: #2a4158; border-radius: 4px; overflow: hidden; } .progress-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; } .progress-bar-fill.danger { background: linear-gradient(90deg, #e94560, #ff6b6b); } .progress-bar-fill.warning { background: linear-gradient(90deg, #ffc107, #ffda6a); } .progress-bar-fill.success { background: linear-gradient(90deg, #28a745, #5dd879); }
        .stock-info { display: flex; flex-direction: column; gap: 5px; } .stock-numbers { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; }
        .image-preview-container { width: 100%; height: 200px; background: #0f3460; border: 2px dashed #2a4158; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; position: relative; cursor: pointer; transition: all 0.3s; } .image-preview-container:hover { border-color: #e94560; background: #1a2a4e; } .image-preview-container.has-image { border-style: solid; border-color: #28a745; } .image-preview-container i { font-size: 40px; color: #4a5568; margin-bottom: 10px; } .image-preview-container span { color: #888; font-size: 13px; } .image-preview { width: 100%; height: 100%; object-fit: cover; display: none; border-radius: 8px; } .image-preview.active { display: block; } .image-info { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 10px; color: white; text-align: center; font-size: 11px; } .btn-remove-image { position: absolute; top: 8px; right: 8px; background: #e94560; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; display: none; z-index: 10; font-size: 12px; } .btn-remove-image.active { display: flex; align-items: center; justify-content: center; }
        .image-preview-container.readonly { cursor: not-allowed; border-color: #2a4158; } .image-preview-container.readonly:hover { background: #0f3460; } .readonly-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 52, 96, 0.7); align-items: center; justify-content: center; text-align: center; color: #fff; font-weight: bold; } .image-preview-container.readonly .readonly-overlay { display: flex; flex-direction: column; }
        .item-thumb { width: 45px; height: 45px; object-fit: cover; border-radius: 6px; background: #0f3460; }
        .empty-state { text-align: center; padding: 40px 20px; color: #888; } .empty-state i { font-size: 48px; margin-bottom: 15px; } .empty-state h3 { margin-bottom: 10px; color: #fff; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .settings-list { list-style: none; max-height: 150px; overflow-y: auto; background: #0f3460; padding: 10px; border-radius: 5px; margin-bottom: 10px; } .settings-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #1a1a2e; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; padding: 20px; } .modal-overlay.active { display: flex; } .modal-content { background: #16213e; padding: 25px; border-radius: 15px; width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; } .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #0f3460; } .modal-header h2 { display: flex; align-items: center; gap: 10px; font-size: 18px; } .modal-close { background: none; border: none; color: #aaa; font-size: 24px; cursor: pointer; padding: 0; } .modal-close:hover { color: #e94560; }
        .info-box { background: #0f3460; padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #17a2b8; } .info-box p { font-size: 13px; color: #aaa; margin: 0; } .info-box i { color: #17a2b8; margin-right: 8px; }
        .org-logo { position: absolute; top: 20px; right: 20px; width: 120px; height: 80px; object-fit: contain; background-color: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 5px; z-index: 50; }
        .app-footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #0f3460; font-size: 13px; color: #888; }
        .app-footer a { color: #aaa; text-decoration: none; }
        .app-footer a:hover { color: #e94560; }
        .login-card .app-version { margin-top: 30px; font-size: 12px; color: #888; }
        .print-only { display: none; }
        .report-signature-block { display: none; }

        /* --- CSS BARU UNTUK RESPONSIVE --- */
        .sidebar-toggle { display: none; background: none; border: none; font-size: 20px; color: #aaa; cursor: pointer; padding: 15px; position: absolute; top: 5px; right: 5px; }
        .sidebar-toggle:hover { color: #fff; }
        .mobile-header-toggle { display: none; }

        @media print { 
            .sidebar, .header button, .no-print, button:not(.btn-print), .form-card.no-print, .app-footer, .sidebar-toggle { display: none !important; } 
            .main-content { margin: 0 !important; padding: 100px 0 0 0 !important; } 
            body { background: white; color: black; } 
            .chart-card, .form-card, .period-card, .transaction-card { background: white; border: 1px solid #ccc; box-shadow: none; page-break-inside: avoid; } 
            th { background: #eee !important; color: #333 !important; } 
            tr, td { border-color: #ddd; } 
            h1, h2, h3, p { color: black; } 
            .status-badge { border: 1px solid black; } 
            .org-logo { top: 10px; right: 10px; background-color: transparent;} 
            .print-only { display: block; margin-top: 30px; }
            .report-signature-block { display: flex; justify-content: space-between; margin-top: 80px; text-align: center; font-size: 14px; }
            .signature-col p { margin-top: 60px; font-weight: bold; border-bottom: 1px solid black; padding-bottom: 5px;}
        }
        @media (max-width: 920px) { .modal-content {max-width: 600px;} .form-container { grid-template-columns: 1fr; display: flex; flex-direction: column-reverse; } }
        
        @media (max-width: 768px) {
            .sidebar { left: -250px; }
            .sidebar.active { left: 0; }
            .sidebar-toggle { display: block; }
            .main-content { margin-left: 0; padding-top: 80px; }
            .header { padding-top: 15px; padding-bottom: 15px; }
            .mobile-header-toggle { display: block; position: fixed; top: 15px; left: 15px; z-index: 999; font-size: 24px; background: #16213e; padding: 5px 12px; border-radius: 8px; color: #fff; }
        }
    </style>
</head>
<body>
    <div id="loginPage"><div class="login-card"><i class="fas fa-warehouse" style="font-size:48px; color:#e94560; margin-bottom:20px;"></i><h2>Stok Manager</h2><p style="color:#888; margin-bottom:20px;">Sistem Manajemen Inventori</p><form onsubmit="handleLogin(event)"><input type="text" id="username" placeholder="Username" required><input type="password" id="password" placeholder="Password" required><button type="submit" class="btn-submit">Masuk</button></form><p class="app-version">Versi <span class="version-text">1.1.0</span> | Dikembangkan oleh <span class="developer-text">Meilody</span></p></div></div>
    <div class="modal-overlay" id="orderModal"><div class="modal-content" style="max-width:450px;"><div class="modal-header"><h2><i class="fas fa-cart-plus"></i> Quick Order</h2><button class="modal-close" onclick="closeModal('orderModal')">&times;</button></div><form onsubmit="submitQuickOrder(event)"><div style="display:flex; gap:15px; margin-bottom:15px;"><img id="orderItemImage" src="" class="item-thumb" style="width:70px; height:70px;"><div><h3 id="orderItemName">-</h3><p style="color:#aaa; font-size:13px;" id="orderItemInfo">-</p></div></div><label>Jumlah Order</label><input type="number" id="orderQty" min="1" required><label>Supplier</label><input type="text" id="orderSupplier" placeholder="Nama supplier..."><input type="hidden" id="orderItemCode"><div style="display:flex; gap:10px; margin-top:15px;"><button type="button" class="btn-red" style="flex:1;" onclick="closeModal('orderModal')">Batal</button><button type="submit" class="btn-green" style="flex:2;"><i class="fas fa-check"></i> Konfirmasi</button></div></form></div></div>
    <div class="modal-overlay" id="addItemModal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-plus-circle" style="color:#6f42c1;"></i> Tambah Data Barang</h2><button class="modal-close" onclick="closeModal('addItemModal')">&times;</button></div><div class="info-box"><p><i class="fas fa-info-circle"></i> Data ini akan disimpan sebagai stok awal periode. Gunakan menu "Barang Masuk" untuk menambah stok operasional.</p></div><form onsubmit="submitAddItem(event)" class="form-container"><div class="form-fields"><div class="form-row"><div><label class="required">Kode Barang</label><input type="text" id="addKode" placeholder="ID-XXX" required></div><div><label class="required">Kategori</label><select id="addKategori" required></select></div></div><label class="required">Nama Barang</label><input type="text" id="addNama" placeholder="Nama lengkap barang..." required><div class="form-row"><div><label>Merk / Brand</label><input type="text" id="addMerk" placeholder="Contoh: Samsung, Logitech..."></div><div><label class="required">Satuan</label><select id="addSatuan" required></select></div></div><div class="form-row-3"><div><label class="required">Stok Awal</label><input type="number" id="addStokAwal" min="0" value="0" required></div><div><label>Min. Stok</label><input type="number" id="addMinStok" min="0" value="10"></div><div><label>Periode</label><select id="addPeriode"><option value="current">Bulan Ini</option><option value="previous">Bulan Lalu</option></select></div></div><div style="display:flex; gap:10px; margin-top:20px;"><button type="button" class="btn-red" style="flex:1;" onclick="closeModal('addItemModal')">Batal</button><button type="submit" class="btn-purple" style="flex:2;"><i class="fas fa-save"></i> Simpan Data Barang</button></div></div>
            <div class="form-image">
                <label for="addImageUrl"><i class="fas fa-link"></i> URL Gambar dari Cloudinary</label>
                <input type="url" id="addImageUrl" placeholder="https://res.cloudinary.com/..." oninput="previewImageFromUrl('add', this.value)">
                <div class="image-preview-container" id="addImageContainer">
                    <img id="previewAdd" class="image-preview" src="" alt="Preview">
                    <i class="fas fa-image"></i>
                    <span>Preview Gambar Akan Muncul Di Sini</span>
                </div>
                <small style="color:#888;">Opsional. Paste URL gambar dari Cloudinary.</small>
            </div>
            </form></div></div>
    <div class="modal-overlay" id="editPeriodItemModal"><div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h2><i class="fas fa-edit" style="color:#ffc107;"></i> Edit Data Periode</h2><button class="modal-close" onclick="closeModal('editPeriodItemModal')">&times;</button></div><form onsubmit="submitEditPeriodItem(event)"><input type="hidden" id="editPeriodKey"><input type="hidden" id="editPeriodItemKode"><label>Kode Barang</label><input type="text" id="editPeriodKode" readonly style="background:#2a4158; cursor: not-allowed;"><label class="required">Nama Barang</label><input type="text" id="editPeriodNama" required><div class="form-row"><div><label>Merk / Brand</label><input type="text" id="editPeriodMerk"></div><div><label class="required">Satuan</label><input type="text" id="editPeriodSatuan" required></div></div><label class="required">Stok Awal Periode Ini</label><input type="number" id="editPeriodStok" min="0" required><small style="color:#888; font-size:11px;">*Mengubah stok hanya untuk catatan periode ini, tidak mempengaruhi stok saat ini.</small><div style="display:flex; gap:10px; margin-top:20px;"><button type="button" class="btn-red" style="flex:1;" onclick="closeModal('editPeriodItemModal')">Batal</button><button type="submit" class="btn-yellow" style="flex:2;"><i class="fas fa-save"></i> Simpan Perubahan</button></div></form></div></div>

    <div id="dashboardContainer" class="dashboard-container" style="display:none;">
        <aside class="sidebar" id="sidebar">
            <button class="sidebar-toggle" onclick="document.getElementById('sidebar').classList.remove('active')"><i class="fas fa-times"></i></button>
            <div class="logo"><i class="fas fa-warehouse"></i> <h2>Stok Manager</h2></div>
            <ul class="menu">
                <li class="active" onclick="navigate('dashboard', this)"><i class="fas fa-home"></i> Beranda</li>
                <li onclick="navigate('statistik', this)"><i class="fas fa-chart-bar"></i> Statistik</li>
                <li onclick="navigate('daftarBarang', this)"><i class="fas fa-boxes"></i> Daftar Barang</li>
                <li onclick="navigate('barangMasuk', this)"><i class="fas fa-arrow-down"></i> Barang Masuk</li>
                <li onclick="navigate('barangKeluar', this)"><i class="fas fa-arrow-up"></i> Barang Keluar</li>
                <li onclick="navigate('transaksi', this)"><i class="fas fa-exchange-alt"></i> Riwayat</li>
                <li onclick="navigate('laporan', this)"><i class="fas fa-file-alt"></i> Laporan</li>
                <li onclick="navigate('pengaturan', this)"><i class="fas fa-cog"></i> Pengaturan</li>
                <li onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</li>
            </ul>
        </aside>
        <main class="main-content">
            <button class="mobile-header-toggle" onclick="document.getElementById('sidebar').classList.add('active')"><i class="fas fa-bars"></i></button>
            <img id="orgLogo" class="org-logo" src="" alt="Logo Organisasi">
            <div id="dashboard" class="page-content active">
                <div class="header"><h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1></div>
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon"><canvas id="chartTotal"></canvas></div>
                        <div><h3>Total Stok</h3><p id="valTotal" style="font-size:24px; font-weight:bold; color:#007bff;">0</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><canvas id="chartMasuk"></canvas></div>
                        <div><h3>Total Masuk</h3><p id="valMasuk" style="font-size:24px; font-weight:bold; color:#28a745;">0</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><canvas id="chartKeluar"></canvas></div>
                        <div><h3>Total Keluar</h3><p id="valKeluar" style="font-size:24px; font-weight:bold; color:#ffc107;">0</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><canvas id="chartItems"></canvas></div>
                        <div><h3>Jenis Barang</h3><p id="valItems" style="font-size:24px; font-weight:bold; color:#6f42c1;">0</p></div>
                    </div>
                    <div class="stat-card danger" id="cardMenipis">
                        <div class="stat-icon"><canvas id="chartMenipis"></canvas></div>
                        <div><h3>Perlu Order</h3><p id="valMenipis" style="font-size:24px; font-weight:bold; color:#e94560;">0</p></div>
                    </div>
                </div>
                <div class="charts-container" style="grid-template-columns: 2fr 1fr;"><div class="chart-card" style="height: 400px;"><div class="chart-header"><h2><i class="fas fa-chart-line"></i> Pergerakan Stok</h2><select id="dashRange" onchange="renderCharts('dashboard')"><option value="week">Mingguan</option><option value="month">Harian</option></select></div><div class="chart-wrapper"><canvas id="chartMovement"></canvas></div></div><div class="chart-card" style="height: 400px;"><div class="chart-header"><h2><i class="fas fa-chart-pie"></i> Distribusi</h2></div><div class="chart-wrapper"><canvas id="chartDist"></canvas></div></div></div><div class="order-table-card"><div class="order-table-header"><h2><i class="fas fa-exclamation-triangle" style="color:#e94560;"></i> Barang Perlu Order <span class="badge-count" id="orderCount">0</span></h2><div class="filter-buttons"><button class="btn-red btn-sm active" onclick="filterOrderTable('all', this)">Semua</button><button class="btn-orange btn-sm" onclick="filterOrderTable('habis', this)">Habis</button><button class="btn-yellow btn-sm" onclick="filterOrderTable('kritis', this)">Kritis</button><button class="btn-blue btn-sm" onclick="filterOrderTable('menipis', this)">Menipis</button></div></div><div class="table-container" style="max-height:300px;"><table id="tblOrder"><thead><tr><th>Gambar</th><th>Kode</th><th>Nama</th><th>Merk</th><th>Stok</th><th>Status</th><th>Aksi</th></tr></thead><tbody></tbody></table></div><div class="empty-state" id="emptyOrderState" style="display:none;"><i class="fas fa-check-circle" style="color:#28a745;"></i><h3>Semua Stok Aman!</h3></div></div></div>
            <div id="statistik" class="page-content"><div class="header"><h1><i class="fas fa-chart-bar"></i> Statistik</h1></div><div class="charts-container"><div class="chart-card"><div class="chart-header"><h2>Top 5 Stok</h2></div><div class="chart-wrapper"><canvas id="chartTop5"></canvas></div></div><div class="chart-card"><div class="chart-header"><h2>Per Kategori</h2></div><div class="chart-wrapper"><canvas id="chartCat"></canvas></div></div></div><div class="chart-card"><div class="chart-header"><h2>Tren Tahunan</h2></div><div class="chart-wrapper"><canvas id="chartTrend"></canvas></div></div></div>
            <div id="laporan" class="page-content">
                <div class="header no-print">
                    <h1 id="reportTitle"><i class="fas fa-file-alt"></i> Laporan</h1>
                    <div class="header-actions">
                        <button class="btn-blue" onclick="exportToJson()"><i class="fas fa-file-export"></i> Ekspor JSON</button>
                        <button class="btn-orange" onclick="document.getElementById('importJsonInput').click()"><i class="fas fa-file-import"></i> Impor JSON</button>
                        <button class="btn-red btn-print" onclick="window.print()"><i class="fas fa-print"></i> Cetak</button>
                    </div>
                </div>
                <input type="file" id="importJsonInput" accept=".json" style="display: none;" onchange="importFromJson(event)">
                <div class="form-card no-print" style="display:flex; gap:10px; align-items: flex-end;">
                    <div style="flex:1;"><label>Bulan</label><select id="repMonth" style="margin:0;"><option value="0">Januari</option><option value="1">Februari</option><option value="2">Maret</option><option value="3">April</option><option value="4">Mei</option><option value="5">Juni</option><option value="6">Juli</option><option value="7">Agustus</option><option value="8">September</option><option value="9">Oktober</option><option value="10">November</option><option value="11">Desember</option></select></div>
                    <div style="flex:1;"><label>Tahun</label><input type="number" id="repYear" value="2024" style="margin:0;"></div>
                    <button class="btn-green" onclick="generateReport()" style="padding: 10px 20px; margin-bottom:15px;"><i class="fas fa-search"></i> Buat Laporan</button>
                </div>
                <div id="reportContent">
                    <div class="charts-container">
                        <div class="chart-card"><div class="chart-header"><h2><i class="fas fa-chart-bar"></i> Pergerakan Stok Periode Ini</h2></div><div class="chart-wrapper"><canvas id="repChartMove"></canvas></div></div>
                        <div class="chart-card"><div class="chart-header"><h2><i class="fas fa-chart-pie"></i> Distribusi Keluar Periode Ini</h2></div><div class="chart-wrapper"><canvas id="repChartDist"></canvas></div></div>
                    </div>
                    <div class="form-card">
                        <h3 id="reportTableTitle">Laporan Stok</h3>
                        <div class="table-container"><table id="tblRepInv"><thead><tr><th>Kode</th><th>Nama</th><th>Merk</th><th>Satuan</th><th>Stok Akhir</th><th>Status</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div class="form-card print-only" id="repLogMasukCard">
                        <h3>Riwayat Barang Masuk Periode Ini</h3>
                        <div class="table-container"><table id="tblRepLogMasuk"><thead><tr><th>Tanggal</th><th>Nama</th><th>Jumlah</th><th>Keterangan</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div class="form-card print-only" id="repLogKeluarCard">
                        <h3>Riwayat Barang Keluar Periode Ini</h3>
                        <div class="table-container"><table id="tblRepLogKeluar"><thead><tr><th>Tanggal</th><th>Nama</th><th>Jumlah</th><th>Tujuan</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div class="report-signature-block">
                        <div class="signature-col">
                            <span>Dilaporkan Oleh,</span>
                            <p id="repReportedBy">(Nama Pelapor)</p>
                        </div>
                        <div class="signature-col">
                            <span>Disetujui Oleh,</span>
                            <p id="repApprovedBy">(Nama Atasan)</p>
                        </div>
                    </div>
                </div>
                <div class="empty-state" id="emptyReportState" style="display:none;"><i class="fas fa-file-excel" style="color:#888;"></i><h3>Tidak Ada Data Transaksi</h3><p>Tidak ditemukan data transaksi pada periode yang dipilih.</p></div>
            </div>
            <div id="daftarBarang" class="page-content"><div class="header"><h1><i class="fas fa-boxes"></i> Daftar Barang</h1><div class="header-actions"><button class="btn-purple" onclick="savePeriodSnapshot()"><i class="fas fa-camera"></i> Snapshot</button><button class="btn-green" onclick="openAddItemModal()"><i class="fas fa-plus"></i> Tambah Barang</button></div></div><div class="period-card"><div class="period-header"><h3><i class="fas fa-history" style="color:#6f42c1;"></i> Stok Periode Sebelumnya</h3><div class="period-selector"><div class="period-nav"><button onclick="changePeriod(-1)"><i class="fas fa-chevron-left"></i></button><button onclick="changePeriod(1)"><i class="fas fa-chevron-right"></i></button></div><select id="periodMonth" onchange="loadPeriodData()"><option value="0">Januari</option><option value="1">Februari</option><option value="2">Maret</option><option value="3">April</option><option value="4">Mei</option><option value="5">Juni</option><option value="6">Juli</option><option value="7">Agustus</option><option value="8">September</option><option value="9">Oktober</option><option value="10">November</option><option value="11">Desember</option></select><input type="number" id="periodYear" value="2024" min="2020" max="2030" onchange="loadPeriodData()" style="width:80px;"><button class="btn-blue btn-sm" onclick="loadPeriodData()"><i class="fas fa-search"></i></button></div></div><div class="period-info"><div class="period-info-item total"><i class="fas fa-cubes"></i><div><small>Total Item</small><br><strong id="periodTotalItems">0</strong></div></div><div class="period-info-item total"><i class="fas fa-boxes"></i><div><small>Total Stok</small><br><strong id="periodTotalStock">0</strong></div></div><div class="period-info-item masuk"><i class="fas fa-arrow-down"></i><div><small>Masuk</small><br><strong id="periodMasuk">0</strong></div></div><div class="period-info-item keluar"><i class="fas fa-arrow-up"></i><div><small>Keluar</small><br><strong id="periodKeluar">0</strong></div></div></div><div class="table-container"><table id="tblPeriod"><thead><tr><th>Gambar</th><th>Kode</th><th>Nama Barang</th><th>Merk</th><th>Satuan</th><th>Stok Awal</th><th>Stok Sekarang</th><th>Perubahan</th><th>Aksi</th></tr></thead><tbody></tbody></table></div><div class="empty-state" id="emptyPeriodState" style="display:none;"><i class="fas fa-calendar-times" style="color:#6f42c1;"></i><h3>Tidak Ada Data Periode</h3><p>Klik "Tambah Barang" untuk menambah data atau "Snapshot" untuk menyimpan data saat ini.</p></div></div><div class="form-card"><h3><i class="fas fa-clipboard-list" style="color:#007bff;"></i> Stok Saat Ini <span style="font-size:13px; color:#888; font-weight:normal;">- Realtime</span></h3><div class="table-container"><table id="tblInv"><thead><tr><th>Gambar</th><th>Kode</th><th>Nama</th><th>Merk</th><th>Satuan</th><th>Stok</th><th>Min</th><th>Status</th><th>Aksi</th></tr></thead><tbody></tbody></table></div></div></div>
            <div id="barangMasuk" class="page-content"><div class="header"><h1><i class="fas fa-arrow-down"></i> Barang Masuk</h1></div><div class="info-box" style="margin-bottom:20px;"><p><i class="fas fa-lightbulb"></i> <strong>Tips:</strong> Pilih barang yang sudah ada untuk restock, atau ketik nama baru untuk menambah item baru.</p></div><div class="form-card"><form onsubmit="submitMasuk(event)" class="form-container"><div class="form-fields"><div class="form-row"><div><label class="required"><i class="fas fa-calendar"></i> Tanggal Masuk</label><input id="inDate" type="date" required></div><div><label class="required"><i class="fas fa-layer-group"></i> Kategori</label><select id="inCat" required></select></div></div><label class="required"><i class="fas fa-box"></i> Nama Barang</label><input id="inName" list="itemSuggestions" placeholder="Ketik atau pilih nama barang..." required><datalist id="itemSuggestions"></datalist><div class="form-row"><div><label><i class="fas fa-tag"></i> Merk / Brand</label><input id="inMerk" placeholder="Contoh: Samsung, Logitech..."></div><div><label class="required"><i class="fas fa-balance-scale"></i> Satuan</label><select id="inSatuan" required></select></div></div><div class="form-row-3"><div><label class="required"><i class="fas fa-plus-circle"></i> Jumlah Masuk</label><input id="inQty" type="number" min="1" placeholder="0" required></div><div><label><i class="fas fa-archive"></i> Stok Awal Periode</label><input id="inStokAwal" type="number" min="0" value="0" placeholder="0"><small style="color:#888; font-size:11px;">*Untuk barang baru</small></div><div><label><i class="fas fa-user-check"></i> Dibeli Oleh</label><select id="inUser"></select></div></div><label><i class="fas fa-sticky-note"></i> Keterangan</label><textarea id="inNote" rows="2" placeholder="Catatan: supplier, nomor PO, dll..."></textarea><button type="submit" class="btn-submit"><i class="fas fa-save"></i> Simpan Barang Masuk</button></div>
            <div class="form-image">
                <label for="inImageUrl"><i class="fas fa-link"></i> URL Gambar (untuk barang baru)</label>
                <input type="url" id="inImageUrl" placeholder="https://res.cloudinary.com/..." oninput="previewImageFromUrl('in', this.value)">
                <div class="image-preview-container" id="inImageContainer">
                     <div class="readonly-overlay"><span><i class="fas fa-lock"></i><br>Gambar Tersedia</span></div>
                    <img id="previewIn" class="image-preview" src="" alt="Preview">
                    <i class="fas fa-image"></i>
                    <span>Preview Gambar Akan Muncul Di Sini</span>
                </div>
                <div id="itemInfoPanel" style="margin-top:15px; display:none;"><div class="item-preview-card"><div class="item-details" style="padding:12px;"><p style="color:#6f42c1; font-weight:bold; margin-bottom:8px;"><i class="fas fa-info-circle"></i> Info Barang (Restock)</p><p><strong id="infoNama">-</strong></p><p>Merk: <span id="infoMerk">-</span></p><p>Stok saat ini: <strong id="infoStok" style="color:#28a745;">0</strong></p></div></div></div>
            </div>
            </form></div></div>
            <div id="barangKeluar" class="page-content"><div class="header"><h1><i class="fas fa-arrow-up"></i> Barang Keluar</h1></div><div class="form-card"><form onsubmit="submitKeluar(event)" class="form-container"><div class="form-fields"><div class="form-row"><div><label class="required"><i class="fas fa-calendar"></i> Tanggal Keluar</label><input id="outDate" type="date" required></div><div><label><i class="fas fa-truck-moving"></i> Tujuan Distribusi</label><select id="outDest"></select></div></div><label class="required"><i class="fas fa-box-open"></i> Pilih Barang</label><select id="outName" required onchange="showItemPreview()"></select><div class="form-row"><div><label><i class="fas fa-tag"></i> Merk</label><input id="outMerk" type="text" readonly></div><div><label><i class="fas fa-balance-scale"></i> Satuan</label><input id="outSatuan" type="text" readonly></div></div><div><label><i class="fas fa-layer-group"></i> Kategori</label><input id="outKategori" type="text" readonly></div><div class="form-row-3"><div><label><i class="fas fa-info-circle"></i> Stok Tersedia</label><input id="outStock" readonly></div><div><label class="required"><i class="fas fa-sort-numeric-down"></i> Jumlah Keluar</label><input id="outQty" type="number" min="1" required oninput="calculateFinalStock()"></div><div><label><i class="fas fa-clipboard-check"></i> Stok Akhir (Prediksi)</label><input id="outStockFinal" readonly></div></div><label><i class="fas fa-sticky-note"></i> Keterangan</label><textarea id="outNote" rows="2" placeholder="Catatan tambahan..."></textarea><button type="submit" class="btn-submit"><i class="fas fa-sign-out-alt"></i> Proses Keluar</button></div><div class="form-image"><label><i class="fas fa-eye"></i> Preview Barang</label><div class="image-preview-container readonly" id="outImageContainer"><div class="readonly-overlay"><span><i class="fas fa-image"></i><br>Preview Barang</span></div><img id="previewOut" class="image-preview" src="" alt="Preview"></div></div></form></div></div>
            <div id="transaksi" class="page-content"><div class="header"><h1><i class="fas fa-exchange-alt"></i> Riwayat Transaksi</h1></div><div class="transaction-card"><h3><span style="display:flex; align-items:center; gap:10px;"><i class="fas fa-arrow-down" style="color:#28a745;"></i> Barang Masuk</span><button class="btn-red btn-sm" title="Hapus Semua Riwayat Masuk" onclick="resetLogs('Masuk')"><i class="fas fa-trash-alt"></i> Hapus Riwayat</button></h3><div class="table-container" style="margin-top:15px;"><table id="tblLogMasuk"><thead><tr><th>Tanggal</th><th>Nama</th><th>Merk</th><th>Jumlah</th><th>Keterangan</th></tr></thead><tbody></tbody></table></div></div><div class="transaction-card"><h3><span style="display:flex; align-items:center; gap:10px;"><i class="fas fa-arrow-up" style="color:#e94560;"></i> Barang Keluar</span><button class="btn-red btn-sm" title="Hapus Semua Riwayat Keluar" onclick="resetLogs('Keluar')"><i class="fas fa-trash-alt"></i> Hapus Riwayat</button></h3><div class="table-container" style="margin-top:15px;"><table id="tblLogKeluar"><thead><tr><th>Tanggal</th><th>Nama</th><th>Merk</th><th>Jumlah</th><th>Tujuan</th></tr></thead><tbody></tbody></table></div></div></div>
            <div id="pengaturan" class="page-content">
                <div class="header"><h1><i class="fas fa-cog"></i> Pengaturan</h1></div>
                <div class="settings-grid">
                    <div class="form-card"><h3><i class="fas fa-building"></i> Info Aplikasi</h3><label>Versi Aplikasi</label><input type="text" id="settingAppVersion"><label>Nama Developer</label><input type="text" id="settingDeveloperName"><button class="btn-blue" onclick="updateAppInfo()" style="width:100%;"><i class="fas fa-save"></i> Simpan Info</button></div>
                    <div class="form-card">
                        <h3><i class="fas fa-user-tie"></i> Penanggung Jawab Laporan</h3>
                        <label>Dilaporkan Oleh</label>
                        <input type="text" id="settingReportedBy" placeholder="Contoh: Staff Gudang">
                        <label>Disetujui Oleh</label>
                        <input type="text" id="settingApprovedBy" placeholder="Contoh: Kepala Gudang">
                        <button class="btn-blue" onclick="updateSignatories()" style="width:100%;"><i class="fas fa-save"></i> Simpan Penanggung Jawab</button>
                    </div>
                    <div class="form-card"><h3><i class="fas fa-image"></i> Logo Organisasi</h3><div class="image-preview-container" id="logoUploadContainer" onclick="document.getElementById('logoUploadInput').click();" title="Klik untuk unggah logo"><img id="logoPreview" class="image-preview" src="" alt="Preview Logo"><i class="fas fa-cloud-upload-alt"></i><span>Klik untuk unggah</span></div><input type="file" id="logoUploadInput" accept="image/png, image/jpeg, image/svg+xml, image/webp" style="display:none" onchange="handleLogoUpload(event)"><small style="color:#888; display:block; text-align:center; margin-bottom: 15px;">Ukuran maks 1MB</small><button class="btn-red" onclick="removeLogo()" style="width:100%;"><i class="fas fa-trash"></i> Hapus Logo</button></div><div class="form-card"><h3><i class="fas fa-sliders-h"></i> Batas Stok</h3><label>Stok Menipis</label><input type="number" id="settingLowStock" value="10"><label>Stok Kritis</label><input type="number" id="settingCritStock" value="5"><button class="btn-blue" onclick="updateSettings()" style="width:100%;"><i class="fas fa-save"></i> Simpan Batas</button></div><div class="form-card"><h3><i class="fas fa-tags"></i> Kategori</h3><div style="display:flex; gap:10px; margin-bottom:10px;"><input id="newCat" placeholder="Kategori baru..." style="margin:0;"><button class="btn-green" onclick="addCat()"><i class="fas fa-plus"></i></button></div><ul id="listCat" class="settings-list"></ul></div><div class="form-card"><h3><i class="fas fa-balance-scale"></i> Satuan</h3><div style="display:flex; gap:10px; margin-bottom:10px;"><input id="newUnit" placeholder="Satuan baru (cth: Rim)..." style="margin:0;"><button class="btn-green" onclick="addUnit()"><i class="fas fa-plus"></i></button></div><ul id="listUnit" class="settings-list"></ul></div><div class="form-card"><h3><i class="fas fa-user-check"></i> Pembeli / User</h3><div style="display:flex; gap:10px; margin-bottom:10px;"><input id="newUser" placeholder="Nama user baru..." style="margin:0;"><button class="btn-green" onclick="addUser()"><i class="fas fa-plus"></i></button></div><ul id="listUser" class="settings-list"></ul></div><div class="form-card"><h3><i class="fas fa-truck-moving"></i> Tujuan Distribusi</h3><div style="display:flex; gap:10px; margin-bottom:10px;"><input id="newDest" placeholder="Tujuan baru (cth: Divisi IT)..." style="margin:0;"><button class="btn-green" onclick="addDest()"><i class="fas fa-plus"></i></button></div><ul id="listDest" class="settings-list"></ul></div>
                </div>
            </div>
            <footer class="app-footer no-print"><span class="version-text"></span> | Dikembangkan oleh <a href="#" class="developer-text" target="_blank"></a></footer>
        </main>
    </div>

    <script>
        // ==================== BAGIAN 1: KONFIGURASI & VARIABEL GLOBAL ====================
        const JSONBIN_API_KEY = "$2a$10$50J.GThHCngwmeIHrmHh3O24WAm4m7U5DKJs.3E7V0hg42UJtkecG";
        const JSONBIN_BIN_ID = "6936cc26d0ea881f401ab15b";
        let JSONBIN_API_URL = "https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest";

        let DB = {};
        const defaultDB = { 
            inventory: [], logs: [], periodSnapshots: {}, orders: [], 
            settings: { 
                logoUrl: '', appVersion: '1.3.0', developerName: 'Meilody',
                categories: ["Elektronik", "Aksesoris", "ATK"], units: ["Pcs", "Unit", "Box"], users: ["Andi", "Budi", "Finance"], destinations: ["Divisi IT", "Divisi Marketing"], 
                lowStockThreshold: 10, criticalStockThreshold: 5,
                reportedBy: 'Staff Gudang', approvedBy: 'Kepala Gudang'
            }
        };
        const activeCharts = {};
        let currentOrderFilter = 'all';

        // ==================== BAGIAN 2: FUNGSI HELPER DASAR & PENYIMPANAN ====================
        function createPlaceholderSvg(text) { return `data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200" viewBox="0 0 300 200"><rect fill="#0f3460" width="300" height="200"/><text fill="#666" font-family="sans-serif" font-size="20" dy="10.5" font-weight="bold" x="50%" y="50%" text-anchor="middle">${text}</text></svg>`)}`; }
        function getStockStatus(item, currentStock) { const stok = currentStock !== undefined ? currentStock : item.stok; const minStock = item.minStock || DB.settings.lowStockThreshold; if (stok <= 0) return { status: 'habis', label: 'HABIS', class: 'habis', icon: 'fa-times-circle', priority: 1 }; if (stok <= DB.settings.criticalStockThreshold) return { status: 'kritis', label: 'KRITIS', class: 'kritis', icon: 'fa-exclamation-circle', priority: 2 }; if (stok < minStock) return { status: 'menipis', label: 'MENIPIS', class: 'menipis', icon: 'fa-exclamation-triangle', priority: 3 }; return { status: 'aman', label: 'AMAN', class: 'aman', icon: 'fa-check-circle', priority: 4 }; }
        function getStockPercentage(item) { const minStock = item.minStock || DB.settings.lowStockThreshold; return Math.min((item.stok / (minStock * 2)) * 100, 100); }
        function getProgressClass(item) { const s = getStockStatus(item).status; if (s === 'habis' || s === 'kritis') return 'danger'; if (s === 'menipis') return 'warning'; return 'success'; }
        function getMonthName(m) { return ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'][m]; }
        function getPeriodKey(y, m) { return `${y}-${m}`; }
        function generateKode() { const idNumbers = DB.inventory.map(item => { if (item.kode && item.kode.startsWith('ID-')) { return parseInt(item.kode.replace('ID-', ''), 10); } return 0; }); const maxId = idNumbers.length > 0 ? Math.max(...idNumbers) : 0; const newIdNumber = maxId + 1; return `ID-${String(newIdNumber).padStart(3, '0')}`; }
        function getElementIdsForType(type) { const cap = type.charAt(0).toUpperCase() + type.slice(1); return { inputId: `${type}Image`, previewId: `preview${cap}`, btnRemoveId: `btnRemove${cap}`, infoId: `imageInfo${cap}`, containerId: `${type}ImageContainer` }; }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        async function saveToCloud(dataToSave) { if (!JSONBIN_BIN_ID || !JSONBIN_API_KEY || JSONBIN_API_KEY.includes("MASUKKAN")) { console.error("Konfigurasi JSONBin tidak lengkap."); return false; } try { const response = await fetch(JSONBIN_API_URL, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_API_KEY }, body: JSON.stringify(dataToSave) }); if (!response.ok) { const errorBody = await response.text(); console.error('Server Response:', errorBody); throw new Error(`Gagal menyimpan data ke cloud. Status: ${response.status}`); } console.log("Data berhasil disimpan ke cloud."); return true; } catch (error) { console.error("Gagal menyimpan ke cloud:", error); alert("Peringatan: Gagal menyimpan data ke server. Periksa konsol (F12) untuk detail."); return false; } }
        async function loadFromCloud() { if (!JSONBIN_BIN_ID || !JSONBIN_API_KEY || JSONBIN_API_KEY.includes("MASUKKAN")) { alert("Konfigurasi Error: 'JSONBIN_API_KEY' atau 'JSONBIN_BIN_ID' belum diisi. Silakan edit kode dan muat ulang."); DB = JSON.parse(JSON.stringify(defaultDB)); return; } console.log("Mencoba memuat data dari cloud..."); try { const response = await fetch(`${JSONBIN_API_URL}/latest`, { headers: { 'X-Master-Key': JSONBIN_API_KEY } }); if (!response.ok) throw new Error(`Gagal mengambil data dari cloud. Status: ${response.status}`); const data = await response.json(); DB = data.record ? { ...defaultDB, ...data.record } : JSON.parse(JSON.stringify(defaultDB)); if(!DB.settings) DB.settings = defaultDB.settings; if(!DB.periodSnapshots) DB.periodSnapshots = {}; console.log("Data berhasil dimuat dari cloud."); } catch (error) { console.error("Gagal load dari cloud:", error); alert("Gagal memuat data dari server. Menggunakan data default."); DB = JSON.parse(JSON.stringify(defaultDB)); } }

        // ==================== BAGIAN 3: FUNGSI INTERAKSI UI & KONTROL FORM ====================
        function openAddItemModal() { const form = document.querySelector('#addItemModal form'); if (form) form.reset(); previewImageFromUrl('add', ''); document.getElementById('addKode').value = generateKode(); document.getElementById('addItemModal').classList.add('active'); }
        function exportToJson() { const dataStr = JSON.stringify(DB, null, 2); const dataBlob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(dataBlob); const a = document.createElement('a'); a.href = url; a.download = `stok_backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); alert(' Data berhasil diekspor!'); }
        function importFromJson(event) { const file = event.target.files[0]; if (file && confirm('Impor data dari file akan menimpa semua data yang ada saat ini. Lanjutkan?')) { const reader = new FileReader(); reader.onload = async (e) => { try { const importedDB = JSON.parse(e.target.result); if (await saveToCloud(importedDB)) { DB = importedDB; alert(' Data berhasil diimpor!'); location.reload(); } } catch (err) { alert(' Format file JSON tidak valid!'); } }; reader.readAsText(file); } event.target.value = ''; }
        function previewImageFromUrl(type, url) { const ids = getElementIdsForType(type); const preview = document.getElementById(ids.previewId); const container = document.getElementById(ids.containerId); if (url && (url.startsWith('http') || url.startsWith('data:image'))) { preview.src = url; preview.classList.add('active'); container.classList.add('has-image'); container.querySelectorAll('i, span:not(.readonly-overlay span)').forEach(el => el.style.display = 'none'); } else { preview.src = ''; preview.classList.remove('active'); container.classList.remove('has-image'); container.querySelectorAll('i, span:not(.readonly-overlay span)').forEach(el => el.style.display = 'block'); } }
        function showItemInfo() { const name = document.getElementById('inName').value.trim(); const item = DB.inventory.find(x => x.nama.toLowerCase() === name.toLowerCase()); const panel = document.getElementById('itemInfoPanel'); const inMerk = document.getElementById('inMerk'), inSatuan = document.getElementById('inSatuan'), inStokAwal = document.getElementById('inStokAwal'), inImageUrl = document.getElementById('inImageUrl'); const imageContainer = document.getElementById('inImageContainer'); if (item) { panel.style.display = 'block'; document.getElementById('infoNama').textContent = item.nama; document.getElementById('infoMerk').textContent = item.merk || '-'; document.getElementById('infoStok').textContent = `${item.stok} ${item.satuan}`; inMerk.value = item.merk || ''; inMerk.readOnly = true; inSatuan.value = item.satuan || 'Pcs'; inSatuan.disabled = true; inStokAwal.value = item.stokAwal || 0; inStokAwal.readOnly = true; inImageUrl.value = item.image || ''; inImageUrl.readOnly = true; imageContainer.classList.add('readonly'); previewImageFromUrl('in', item.image); } else { panel.style.display = 'none'; inMerk.value = ''; inMerk.readOnly = false; inSatuan.value = ''; inSatuan.disabled = false; inStokAwal.value = 0; inStokAwal.readOnly = false; inImageUrl.value = ''; inImageUrl.readOnly = false; imageContainer.classList.remove('readonly'); previewImageFromUrl('in', ''); } }
        function showItemPreview() { const outName = document.getElementById('outName').value; const item = DB.inventory.find(x => x.nama === outName); const fields = { merk: document.getElementById('outMerk'), satuan: document.getElementById('outSatuan'), kategori: document.getElementById('outKategori'), stok: document.getElementById('outStock'), qty: document.getElementById('outQty'), stockFinal: document.getElementById('outStockFinal'), preview: document.getElementById('previewOut'), container: document.getElementById('outImageContainer') }; if (item) { fields.merk.value = item.merk || '-'; fields.satuan.value = item.satuan || 'Pcs'; fields.kategori.value = item.kategori || '-'; fields.stok.value = item.stok; fields.stok.style.color = item.stok > (item.minStock || DB.settings.lowStockThreshold) ? '#28a745' : '#e94560'; fields.preview.src = item.image || createPlaceholderSvg('No Img'); if(item.image && !item.image.includes('svg+xml')) { fields.preview.classList.add('active'); fields.container.classList.add('has-image'); } else { fields.preview.classList.remove('active'); fields.container.classList.remove('has-image'); } fields.qty.value = ''; calculateFinalStock(); } else { Object.values(fields).forEach(el => { if(el.tagName === 'INPUT') el.value = ''; }); fields.preview.src = createPlaceholderSvg('Pilih Barang'); fields.preview.classList.remove('active'); fields.container.classList.remove('has-image'); } }
        function calculateFinalStock() { const currentStock = parseInt(document.getElementById('outStock').value) || 0; const qty = parseInt(document.getElementById('outQty').value) || 0; const finalStockField = document.getElementById('outStockFinal'); const finalStock = currentStock - qty; finalStockField.value = finalStock; if (finalStock < 0) { finalStockField.style.color = '#e94560'; finalStockField.style.fontWeight = 'bold'; } else { finalStockField.style.color = '#28a745'; finalStockField.style.fontWeight = 'normal'; } }
        async function openOrderModal(kode) { const item = DB.inventory.find(x => x.kode === kode); if (!item) return; document.getElementById('orderItemImage').src = item.image || createPlaceholderSvg(''); document.getElementById('orderItemName').textContent = item.nama; document.getElementById('orderItemInfo').innerHTML = `${item.merk || '-'} | Stok: <strong style="color:#e94560;">${item.stok}</strong> ${item.satuan}`; document.getElementById('orderItemCode').value = kode; document.getElementById('orderQty').value = Math.max((item.minStock || 10) - item.stok, 1); document.getElementById('orderModal').classList.add('active'); }
        async function submitQuickOrder(e) { e.preventDefault(); const item = DB.inventory.find(x => x.kode === document.getElementById('orderItemCode').value); alert(` Order: ${item.nama} x${document.getElementById('orderQty').value}`); closeModal('orderModal'); }
        function filterOrderTable(filter, btn) { currentOrderFilter = filter; document.querySelectorAll('.filter-buttons button').forEach(b => b.classList.remove('active')); if (btn) btn.classList.add('active'); updateOrderTable(); }
        
        // ==================== BAGIAN 4: FUNGSI CORE LOGIC (CRUD) ====================
        async function resetLogs(type) { if (confirm(`Anda yakin ingin menghapus semua riwayat barang ${type}? Aksi ini tidak dapat dibatalkan.`)) { const tempDB = JSON.parse(JSON.stringify(DB)); tempDB.logs = tempDB.logs.filter(log => log.type !== type); if (await saveToCloud(tempDB)) { DB = tempDB; alert(` Semua riwayat barang ${type} telah dihapus.`); updateTables(); } } }
        async function updateAppInfo() { const tempDB = JSON.parse(JSON.stringify(DB)); tempDB.settings.appVersion = document.getElementById('settingAppVersion').value; tempDB.settings.developerName = document.getElementById('settingDeveloperName').value; if (await saveToCloud(tempDB)) { DB = tempDB; alert(' Info aplikasi berhasil disimpan!'); applyAppInfo(); } }
        async function updateSignatories() { const tempDB = JSON.parse(JSON.stringify(DB)); tempDB.settings.reportedBy = document.getElementById('settingReportedBy').value; tempDB.settings.approvedBy = document.getElementById('settingApprovedBy').value; if (await saveToCloud(tempDB)) { DB = tempDB; alert(' Nama penanggung jawab berhasil disimpan!'); } }
        async function handleLogoUpload(event) { const file = event.target.files[0]; if (file) { if (file.size > 1 * 1024 * 1024) { alert('Ukuran file maksimal 1MB!'); return; } const reader = new FileReader(); reader.onload = async (e) => { const tempDB = JSON.parse(JSON.stringify(DB)); tempDB.settings.logoUrl = e.target.result; if (await saveToCloud(tempDB)) { DB = tempDB; alert(' Logo berhasil diunggah!'); applyLogo(); } }; reader.readAsDataURL(file); } }
        async function removeLogo() { if (confirm('Hapus logo organisasi?')) { const tempDB = JSON.parse(JSON.stringify(DB)); tempDB.settings.logoUrl = ''; if (await saveToCloud(tempDB)) { DB = tempDB; alert(' Logo berhasil dihapus.'); applyLogo(); } } }
        function addCat() { addToList('categories', 'newCat'); }
        function addUnit() { addToList('units', 'newUnit'); }
        function addUser() { addToList('users', 'newUser'); }
        function addDest() { addToList('destinations', 'newDest'); }
        function delCat(index) { deleteFromList('categories', index); }
        function delUnit(index) { deleteFromList('units', index); }
        function delUser(index) { deleteFromList('users', index); }
        function delDest(index) { deleteFromList('destinations', index); }
        async function submitAddItem(e) { e.preventDefault(); const kode = document.getElementById('addKode').value.trim(), nama = document.getElementById('addNama').value.trim(); if (DB.inventory.find(x => x.kode === kode || x.nama.toLowerCase() === nama.toLowerCase())) { alert(' Kode atau Nama barang sudah ada!'); return; } const merk = document.getElementById('addMerk').value.trim(), kategori = document.getElementById('addKategori').value, satuan = document.getElementById('addSatuan').value; const stokAwal = parseInt(document.getElementById('addStokAwal').value) || 0, minStok = parseInt(document.getElementById('addMinStok').value) || DB.settings.lowStockThreshold; const periode = document.getElementById('addPeriode').value; const imageUrl = document.getElementById('addImageUrl').value.trim(); const image = imageUrl || createPlaceholderSvg(nama); const newItem = { kode, nama, merk, kategori, satuan, stok: stokAwal, stokAwal: stokAwal, minStock: minStok, image }; const tempDB = JSON.parse(JSON.stringify(DB)); tempDB.inventory.push(newItem); const now = new Date(); let targetMonth = now.getMonth(), targetYear = now.getFullYear(); if (periode === 'previous') { targetMonth--; if (targetMonth < 0) { targetMonth = 11; targetYear--; } } const key = getPeriodKey(targetYear, targetMonth); if (!tempDB.periodSnapshots[key]) tempDB.periodSnapshots[key] = { date: new Date().toISOString().split('T')[0], items: [], summary: { masuk: 0, keluar: 0 } }; tempDB.periodSnapshots[key].items.push({ ...newItem }); if (await saveToCloud(tempDB)) { DB = tempDB; alert(` Barang "${nama}" berhasil ditambahkan!`); closeModal('addItemModal'); e.target.reset(); previewImageFromUrl('add', ''); await updateTables(); loadPeriodData(); } }
        async function submitMasuk(e) { e.preventDefault(); const nama = document.getElementById('inName').value.trim(); const qty = parseInt(document.getElementById('inQty').value); const date = document.getElementById('inDate').value; const note = document.getElementById('inNote').value; const dibeliOleh = document.getElementById('inUser').value; let fullNote = dibeliOleh ? `[Oleh: ${dibeliOleh}] ${note}` : note; const tempDB = JSON.parse(JSON.stringify(DB)); let itemIndex = tempDB.inventory.findIndex(x => x.nama.toLowerCase() === nama.toLowerCase()); if (itemIndex !== -1) { tempDB.inventory[itemIndex].stok += qty; tempDB.logs.unshift({ date, type: 'Masuk', kode: tempDB.inventory[itemIndex].kode, name: nama, merk: tempDB.inventory[itemIndex].merk, qty, note: fullNote, image: tempDB.inventory[itemIndex].image }); if(await saveToCloud(tempDB)) { DB = tempDB; alert(` Restock berhasil!`); e.target.reset(); showItemInfo(); updateTables(); } } else { const merk = document.getElementById('inMerk').value.trim(); const satuan = document.getElementById('inSatuan').value; const minStock = DB.settings.lowStockThreshold; const kategori = document.getElementById('inCat').value; const stokAwal = parseInt(document.getElementById('inStokAwal').value) || 0; const imageUrl = document.getElementById('inImageUrl').value.trim(); const image = imageUrl || createPlaceholderSvg(nama); const kode = generateKode(); const newItem = { kode, nama, merk, kategori, satuan, stok: stokAwal + qty, stokAwal, minStock, image }; tempDB.inventory.push(newItem); tempDB.logs.unshift({ date, type: 'Masuk', kode: newItem.kode, name: nama, merk, qty, note: fullNote, image }); if(await saveToCloud(tempDB)) { DB = tempDB; alert(` Barang baru "${nama}" berhasil ditambahkan!`); e.target.reset(); showItemInfo(); updateTables(); } } }
        async function submitKeluar(e) { e.preventDefault(); const nama = document.getElementById('outName').value; const qty = parseInt(document.getElementById('outQty').value); const date = document.getElementById('outDate').value; const dest = document.getElementById('outDest').value; const itemIndex = DB.inventory.findIndex(x => x.nama === nama); if (itemIndex === -1) { alert(' Silakan pilih barang terlebih dahulu!'); return; } const item = DB.inventory[itemIndex]; if (item.stok >= qty) { const tempDB = JSON.parse(JSON.stringify(DB)); tempDB.inventory[itemIndex].stok -= qty; tempDB.logs.unshift({ date, type: 'Keluar', kode: item.kode, name: nama, merk: item.merk, qty, dest, image: item.image }); if(await saveToCloud(tempDB)){ DB = tempDB; alert(` Barang keluar berhasil!`); e.target.reset(); updateTables(); showItemPreview(); } } else { alert(' Stok tidak mencukupi!'); } }
        async function updateSettings() { const tempDB = JSON.parse(JSON.stringify(DB)); tempDB.settings.lowStockThreshold = parseInt(document.getElementById('settingLowStock').value) || 10; tempDB.settings.criticalStockThreshold = parseInt(document.getElementById('settingCritStock').value) || 5; if(await saveToCloud(tempDB)){ DB = tempDB; updateTables(); alert(' Pengaturan disimpan!'); } }
        async function addToList(listName, inputId) { const value = document.getElementById(inputId).value.trim(); if (value && !DB.settings[listName].find(v => v.toLowerCase() === value.toLowerCase())) { const tempDB = JSON.parse(JSON.stringify(DB)); tempDB.settings[listName].push(value); if(await saveToCloud(tempDB)) { DB = tempDB; document.getElementById(inputId).value = ''; updateTables(); } } else if (value) { alert('Data sudah ada!'); } }
        async function deleteFromList(listName, index) { if(confirm(`Hapus item "${DB.settings[listName][index]}" dari daftar?`)) {const tempDB = JSON.parse(JSON.stringify(DB)); tempDB.settings[listName].splice(index, 1); if(await saveToCloud(tempDB)) { DB = tempDB; updateTables(); }} }
        async function delItem(k) { if (confirm('Hapus barang ini secara permanen dari semua data?')) { const tempDB = JSON.parse(JSON.stringify(DB)); tempDB.inventory = tempDB.inventory.filter(x => x.kode !== k); if(await saveToCloud(tempDB)) { DB = tempDB; updateTables(); renderCharts('dashboard'); } } }
        
        // ==================== BAGIAN 5: FUNGSI RENDERING & NAVIGASI ====================
        function createChart(id, type, data, opts = {}) { const ctx = document.getElementById(id); if (!ctx) return null; if (activeCharts[id]) { activeCharts[id].destroy(); delete activeCharts[id]; } const def = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#eee' } } } }; if (type === 'bar' || type === 'line') def.scales = { x: { ticks: { color: '#aaa' }, grid: { color: '#2a4158' } }, y: { ticks: { color: '#aaa' }, grid: { color: '#2a4158' } } }; activeCharts[id] = new Chart(ctx, { type, data, options: { ...def, ...opts } }); return activeCharts[id]; }
        function renderCharts(page) { if (page === 'dashboard') { const total = DB.inventory.reduce((a, b) => a + b.stok, 0); const masuk = DB.logs.filter(x => x.type === 'Masuk').reduce((a, b) => a + b.qty, 0); const keluar = DB.logs.filter(x => x.type === 'Keluar').reduce((a, b) => a + b.qty, 0); const menipis = DB.inventory.filter(x => getStockStatus(x).status !== 'aman').length; const totalItems = DB.inventory.length; document.getElementById('valTotal').innerText = total; document.getElementById('valMasuk').innerText = masuk; document.getElementById('valKeluar').innerText = keluar; document.getElementById('valItems').innerText = totalItems; document.getElementById('valMenipis').innerText = menipis; const miniOpt = { plugins: { legend: { display: false } }, cutout: '70%' }; createChart('chartTotal', 'doughnut', { datasets: [{ data: [total, Math.max(1, total * 0.1)], backgroundColor: ['#007bff', '#2a4158'], borderWidth: 0 }] }, miniOpt); createChart('chartMasuk', 'doughnut', { datasets: [{ data: [masuk, Math.max(1, masuk * 0.1)], backgroundColor: ['#28a745', '#2a4158'], borderWidth: 0 }] }, miniOpt); createChart('chartKeluar', 'doughnut', { datasets: [{ data: [keluar, Math.max(1, keluar * 0.1)], backgroundColor: ['#ffc107', '#2a4158'], borderWidth: 0 }] }, miniOpt); createChart('chartItems', 'doughnut', { datasets: [{ data: [totalItems, Math.max(1, totalItems * 0.1)], backgroundColor: ['#6f42c1', '#2a4158'], borderWidth: 0 }] }, miniOpt); createChart('chartMenipis', 'doughnut', { datasets: [{ data: [menipis, Math.max(DB.inventory.length - menipis, 1)], backgroundColor: ['#e94560', '#2a4158'], borderWidth: 0 }] }, miniOpt); const range = document.getElementById('dashRange')?.value || 'week', labels = range === 'week' ? ['Mg 1', 'Mg 2', 'Mg 3', 'Mg 4'] : Array.from({ length: 30 }, (_, i) => `${i + 1}`); createChart('chartMovement', 'bar', { labels, datasets: [{ label: 'Masuk', data: labels.map(() => Math.floor(Math.random() * 15) + 1), backgroundColor: '#28a745' }, { label: 'Keluar', data: labels.map(() => Math.floor(Math.random() * 10) + 1), backgroundColor: '#dc3545' }] }); const distData = {}; DB.logs.filter(x => x.type === 'Keluar').forEach(x => { const dest = x.dest || 'Lainnya'; distData[dest] = (distData[dest] || 0) + x.qty}); createChart('chartDist', 'doughnut', { labels: Object.keys(distData), datasets: [{ data: Object.values(distData), backgroundColor: ['#007bff', '#28a745', '#ffc107', '#e94560', '#6f42c1', '#fd7e14'] }] }); } if (page === 'statistik') { const sorted = [...DB.inventory].sort((a, b) => b.stok - a.stok).slice(0, 5); createChart('chartTop5', 'bar', { labels: sorted.map(x => x.nama), datasets: [{ label: 'Stok', data: sorted.map(x => x.stok), backgroundColor: ['#e94560', '#007bff', '#28a745', '#ffc107', '#17a2b8'] }] }, { indexAxis: 'y' }); const catData = {}; DB.inventory.forEach(x => catData[x.kategori] = (catData[x.kategori] || 0) + x.stok); createChart('chartCat', 'pie', { labels: Object.keys(catData), datasets: [{ data: Object.values(catData), backgroundColor: ['#007bff', '#28a745', '#ffc107', '#e94560', '#6f42c1'] }] }); createChart('chartTrend', 'line', { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'], datasets: [{ label: 'Masuk', data: [10, 20, 15, 25, 18, 22, 30, 28, 35, 40, 32, 45], borderColor: '#28a745', fill: true, backgroundColor: 'rgba(40,167,69,0.1)', tension: 0.3 }, { label: 'Keluar', data: [5, 12, 10, 18, 15, 20, 22, 25, 28, 30, 25, 35], borderColor: '#dc3545', fill: true, backgroundColor: 'rgba(220,53,69,0.1)', tension: 0.3 }] }); } }
        function applyLogo() { const logoUrl = DB.settings.logoUrl; const logoEl = document.getElementById('orgLogo'); const logoPreviewEl = document.getElementById('logoPreview'); const logoContainer = document.getElementById('logoUploadContainer'); if (logoUrl) { if (logoEl) { logoEl.src = logoUrl; logoEl.style.display = 'block'; } if (logoPreviewEl) { logoPreviewEl.src = logoUrl; logoPreviewEl.classList.add('active'); if (logoContainer) logoContainer.classList.add('has-image'); } } else { if (logoEl) { logoEl.style.display = 'none'; } if (logoPreviewEl) { logoPreviewEl.src = ''; logoPreviewEl.classList.remove('active'); if (logoContainer) logoContainer.classList.remove('has-image'); } } }
        function applyAppInfo() { const version = DB.settings.appVersion || '1.1.0'; const devName = DB.settings.developerName || 'Meilody'; document.querySelectorAll('.version-text').forEach(el => el.textContent = version); document.querySelectorAll('.developer-text').forEach(el => { el.textContent = devName; if (el.tagName === 'A') el.href = `https://github.com/${devName}`; }); }
        function loadPeriodData() { const month = parseInt(document.getElementById('periodMonth').value); const year = parseInt(document.getElementById('periodYear').value); const tbody = document.querySelector('#tblPeriod tbody'); const emptyState = document.getElementById('emptyPeriodState'); const tableContainer = tbody.closest('.table-container'); const key = getPeriodKey(year, month); const periodData = DB.periodSnapshots ? DB.periodSnapshots[key] : null; if (periodData && periodData.items.length > 0) { if (tableContainer) tableContainer.style.display = 'block'; if (emptyState) emptyState.style.display = 'none'; tbody.innerHTML = ''; let totalStockStart = 0; periodData.items.forEach(item => { const currentItem = DB.inventory.find(i => i.kode === item.kode); const currentStock = currentItem ? currentItem.stok : 0; const stockChange = currentStock - item.stokAwal; let changeIndicator = ''; if (!currentItem) { changeIndicator = `<span class="change-indicator down">DIHAPUS</span>`; } else if (stockChange > 0) { changeIndicator = `<span class="change-indicator up"><i class="fas fa-arrow-up"></i> +${stockChange}</span>`; } else if (stockChange < 0) { changeIndicator = `<span class="change-indicator down"><i class="fas fa-arrow-down"></i> ${stockChange}</span>`; } else { changeIndicator = `<span class="change-indicator same"><i class="fas fa-equals"></i> 0</span>`; } tbody.innerHTML += `<tr><td><img src="${item.image || createPlaceholderSvg('')}" class="item-thumb"></td><td>${item.kode}</td><td>${item.nama}</td><td>${item.merk || '-'}</td><td>${item.satuan}</td><td>${item.stokAwal}</td><td>${currentStock}</td><td>${changeIndicator}</td><td><button class="btn-yellow btn-sm" onclick="openEditPeriodItemModal('${key}', '${item.kode}')"><i class="fas fa-edit"></i></button></td></tr>`; totalStockStart += item.stokAwal; }); document.getElementById('periodTotalItems').textContent = periodData.items.length; document.getElementById('periodTotalStock').textContent = totalStockStart; const summary = periodData.summary || { masuk: 0, keluar: 0 }; document.getElementById('periodMasuk').textContent = summary.masuk; document.getElementById('periodKeluar').textContent = summary.keluar; } else { if (tableContainer) tableContainer.style.display = 'none'; if (emptyState) emptyState.style.display = 'block'; tbody.innerHTML = ''; document.getElementById('periodTotalItems').textContent = 0; document.getElementById('periodTotalStock').textContent = 0; document.getElementById('periodMasuk').textContent = 0; document.getElementById('periodKeluar').textContent = 0; } }
        function changePeriod(offset) { const monthEl = document.getElementById('periodMonth'); const yearEl = document.getElementById('periodYear'); let month = parseInt(monthEl.value); let year = parseInt(yearEl.value); month += offset; if (month > 11) { month = 0; year++; } if (month < 0) { month = 11; year--; } monthEl.value = month; yearEl.value = year; loadPeriodData(); }
        async function savePeriodSnapshot() { if (!confirm("Simpan snapshot data stok saat ini untuk bulan ini? Data yang sudah ada akan ditimpa.")) return; const now = new Date(); const key = getPeriodKey(now.getFullYear(), now.getMonth()); const tempDB = JSON.parse(JSON.stringify(DB)); const logsThisMonth = tempDB.logs.filter(l => { const logDate = new Date(l.date); return logDate.getFullYear() === now.getFullYear() && logDate.getMonth() === now.getMonth(); }); tempDB.periodSnapshots[key] = { date: now.toISOString().split('T')[0], items: JSON.parse(JSON.stringify(tempDB.inventory)), summary: { masuk: logsThisMonth.filter(l => l.type === 'Masuk').reduce((sum, l) => sum + l.qty, 0), keluar: logsThisMonth.filter(l => l.type === 'Keluar').reduce((sum, l) => sum + l.qty, 0) } }; if (await saveToCloud(tempDB)) { DB = tempDB; alert(` Snapshot untuk ${getMonthName(now.getMonth())} ${now.getFullYear()} berhasil disimpan!`); loadPeriodData(); } }
        function openEditPeriodItemModal(key, kode) { const periodData = DB.periodSnapshots[key]; const item = periodData.items.find(i => i.kode === kode); if (!item) return; document.getElementById('editPeriodKey').value = key; document.getElementById('editPeriodItemKode').value = kode; document.getElementById('editPeriodKode').value = item.kode; document.getElementById('editPeriodNama').value = item.nama; document.getElementById('editPeriodMerk').value = item.merk || ''; document.getElementById('editPeriodSatuan').value = item.satuan; document.getElementById('editPeriodStok').value = item.stokAwal; document.getElementById('editPeriodItemModal').classList.add('active'); }
        async function submitEditPeriodItem(e) { e.preventDefault(); const key = document.getElementById('editPeriodKey').value; const kode = document.getElementById('editPeriodItemKode').value; const tempDB = JSON.parse(JSON.stringify(DB)); const itemIndex = tempDB.periodSnapshots[key].items.findIndex(i => i.kode === kode); if (itemIndex > -1) { tempDB.periodSnapshots[key].items[itemIndex].nama = document.getElementById('editPeriodNama').value; tempDB.periodSnapshots[key].items[itemIndex].merk = document.getElementById('editPeriodMerk').value; tempDB.periodSnapshots[key].items[itemIndex].satuan = document.getElementById('editPeriodSatuan').value; tempDB.periodSnapshots[key].items[itemIndex].stokAwal = parseInt(document.getElementById('editPeriodStok').value) || 0; if (await saveToCloud(tempDB)) { DB = tempDB; alert(' Data periode berhasil diperbarui!'); closeModal('editPeriodItemModal'); loadPeriodData(); } } }
        function generateReport() { const month = parseInt(document.getElementById('repMonth').value); const year = parseInt(document.getElementById('repYear').value); const monthName = getMonthName(month); document.getElementById('reportTitle').innerHTML = `<i class="fas fa-file-alt"></i> Laporan - ${monthName} ${year}`; document.getElementById('reportTableTitle').innerText = `Laporan Stok Akhir Periode (${monthName} ${year})`; const startDate = new Date(year, month, 1); const endDate = new Date(year, month + 1, 0, 23, 59, 59); const reportLogs = DB.logs.filter(log => { const logDate = new Date(log.date); return logDate >= startDate && logDate <= endDate; }); const reportContent = document.getElementById('reportContent'); const emptyState = document.getElementById('emptyReportState'); if (reportLogs.length === 0 && DB.inventory.length === 0) { reportContent.style.display = 'none'; emptyState.style.display = 'block'; return; } reportContent.style.display = 'block'; emptyState.style.display = 'none'; const totalMasuk = reportLogs.filter(l => l.type === 'Masuk').reduce((sum, l) => sum + l.qty, 0); const totalKeluar = reportLogs.filter(l => l.type === 'Keluar').reduce((sum, l) => sum + l.qty, 0); createChart('repChartMove', 'bar', { labels: ['Barang Masuk', 'Barang Keluar'], datasets: [{ label: 'Jumlah', data: [totalMasuk, totalKeluar], backgroundColor: ['#28a745', '#e94560'] }] }); const distributionData = {}; reportLogs.filter(l => l.type === 'Keluar').forEach(log => { const dest = log.dest || 'Tidak Diketahui'; distributionData[dest] = (distributionData[dest] || 0) + log.qty; }); createChart('repChartDist', 'doughnut', { labels: Object.keys(distributionData), datasets: [{ data: Object.values(distributionData), backgroundColor: ['#007bff', '#fd7e14', '#ffc107', '#17a2b8', '#6f42c1', '#20c997'] }] }); const historicalInventory = JSON.parse(JSON.stringify(DB.inventory)); const logsAfterPeriod = DB.logs.filter(log => new Date(log.date) > endDate); logsAfterPeriod.reverse().forEach(log => { const item = historicalInventory.find(i => i.kode === log.kode); if (item) { if (log.type === 'Masuk') item.stok -= log.qty; else item.stok += log.qty; } }); const tbRep = document.querySelector('#tblRepInv tbody'); tbRep.innerHTML = ''; historicalInventory.forEach(item => { const s = getStockStatus(item, item.stok); tbRep.innerHTML += `<tr><td>${item.kode}</td><td>${item.nama}</td><td>${item.merk || '-'}</td><td>${item.satuan}</td><td>${item.stok}</td><td><span class="status-badge ${s.class}">${s.label}</span></td></tr>`; }); const tbRepMasuk = document.querySelector('#tblRepLogMasuk tbody'); const repLogMasukCard = document.getElementById('repLogMasukCard'); const logsMasuk = reportLogs.filter(l => l.type === 'Masuk'); tbRepMasuk.innerHTML = ''; if (logsMasuk.length > 0) { repLogMasukCard.style.display = 'block'; logsMasuk.forEach(l => tbRepMasuk.innerHTML += `<tr><td>${l.date}</td><td>${l.name}</td><td>+${l.qty}</td><td>${l.note || '-'}</td></tr>`); } else { repLogMasukCard.style.display = 'none'; } const tbRepKeluar = document.querySelector('#tblRepLogKeluar tbody'); const repLogKeluarCard = document.getElementById('repLogKeluarCard'); const logsKeluar = reportLogs.filter(l => l.type === 'Keluar'); tbRepKeluar.innerHTML = ''; if (logsKeluar.length > 0) { repLogKeluarCard.style.display = 'block'; logsKeluar.forEach(l => tbRepKeluar.innerHTML += `<tr><td>${l.date}</td><td>${l.name}</td><td>-${l.qty}</td><td>${l.dest || '-'}</td></tr>`); } else { repLogKeluarCard.style.display = 'none'; } document.getElementById('repReportedBy').textContent = DB.settings.reportedBy || '(Nama Pelapor)'; document.getElementById('repApprovedBy').textContent = DB.settings.approvedBy || '(Nama Atasan)'; }
        function updateOrderTable() { const tbody = document.querySelector('#tblOrder tbody'); const empty = document.getElementById('emptyOrderState'); const table = document.getElementById('tblOrder'); let items = DB.inventory.filter(i => getStockStatus(i).status !== 'aman'); if (currentOrderFilter === 'habis') items = items.filter(i => i.stok <= 0); else if (currentOrderFilter === 'kritis') items = items.filter(i => i.stok > 0 && i.stok <= DB.settings.criticalStockThreshold); else if (currentOrderFilter === 'menipis') items = items.filter(i => getStockStatus(i).status === 'menipis'); items.sort((a, b) => getStockStatus(a).priority - getStockStatus(b).priority); document.getElementById('orderCount').textContent = DB.inventory.filter(i => getStockStatus(i).status !== 'aman').length; if (items.length === 0) { table.style.display = 'none'; empty.style.display = 'block'; }  else { table.style.display = 'table'; empty.style.display = 'none'; } tbody.innerHTML = ''; items.forEach(i => { const s = getStockStatus(i); tbody.innerHTML += `<tr><td><img src="${i.image || createPlaceholderSvg('')}" class="item-thumb"></td><td>${i.kode}</td><td><strong>${i.nama}</strong><br><small style="color:#888;">${i.satuan}</small></td><td>${i.merk || '-'}</td><td><div class="stock-info"><div class="stock-numbers"><span style="font-size:16px; font-weight:bold; color:${s.class === 'aman' ? '#28a745' : '#e94560'};">${i.stok}</span><span>/${i.minStock||10}</span></div><div class="progress-bar"><div class="progress-bar-fill ${getProgressClass(i)}" style="width:${getStockPercentage(i)}%"></div></div></div></td><td><span class="status-badge ${s.class}"><i class="fas ${s.icon}"></i> ${s.label}</span></td><td><button class="btn-green btn-sm" onclick="openOrderModal('${i.kode}')"><i class="fas fa-cart-plus"></i></button></td></tr>`; }); }
        async function updateTables() { const populateDropdown = (id, data, placeholder) => { const select = document.getElementById(id); if(select) { select.innerHTML = placeholder ? `<option value="" disabled selected>${placeholder}</option>` : ''; data.forEach(item => select.innerHTML += `<option value="${item}">${item}</option>`); } }; const populateDataList = (id, data) => { const datalist = document.getElementById(id); if (datalist) { datalist.innerHTML = ''; data.forEach(item => datalist.innerHTML += `<option value="${item}">`); } }; populateDataList('itemSuggestions', DB.inventory.map(i => i.nama)); populateDropdown('addKategori', DB.settings.categories); populateDropdown('addSatuan', DB.settings.units); populateDropdown('inCat', DB.settings.categories); populateDropdown('inSatuan', DB.settings.units); populateDropdown('inUser', DB.settings.users, '-- Pilih User --'); populateDropdown('outName', DB.inventory.filter(i => i.stok > 0).map(i => i.nama), '-- Pilih Barang --'); populateDropdown('outDest', DB.settings.destinations, '-- Pilih Tujuan --'); const renderList = (listId, data, deleteFn, icon) => { const list = document.getElementById(listId); if (list) { list.innerHTML = ''; data.forEach((item, i) => list.innerHTML += `<li><span><i class="fas ${icon}"></i> ${item}</span><button class="btn-red btn-sm" onclick="${deleteFn}(${i})"><i class="fas fa-times"></i></button></li>`); } }; renderList('listCat', DB.settings.categories, 'delCat', 'fa-tags'); renderList('listUnit', DB.settings.units, 'delUnit', 'fa-balance-scale'); renderList('listUser', DB.settings.users, 'delUser', 'fa-user-check'); renderList('listDest', DB.settings.destinations, 'delDest', 'fa-truck-moving'); applyLogo(); applyAppInfo(); document.getElementById('settingAppVersion').value = DB.settings.appVersion; document.getElementById('settingDeveloperName').value = DB.settings.developerName; document.getElementById('settingReportedBy').value = DB.settings.reportedBy || ''; document.getElementById('settingApprovedBy').value = DB.settings.approvedBy || ''; const tbInv = document.querySelector('#tblInv tbody'); if (tbInv) { tbInv.innerHTML = ''; DB.inventory.forEach(i => { const s = getStockStatus(i); tbInv.innerHTML += `<tr><td><img src="${i.image || createPlaceholderSvg('No Img')}" class="item-thumb"></td><td>${i.kode}</td><td><strong>${i.nama}</strong></td><td>${i.merk || '-'}</td><td>${i.satuan || 'Pcs'}</td><td><strong style="color:${s.status === 'aman' ? '#28a745' : '#e94560'}">${i.stok}</strong></td><td>${i.minStock || 10}</td><td><span class="status-badge ${s.class}"><i class="fas ${s.icon}"></i> ${s.label}</span></td><td><button class="btn-red btn-sm" onclick="delItem('${i.kode}')"><i class="fas fa-trash"></i></button> ${s.status !== 'aman' ? `<button class="btn-green btn-sm" onclick="openOrderModal('${i.kode}')"><i class="fas fa-cart-plus"></i></button>` : ''}</td></tr>`; }); } const tbM = document.querySelector('#tblLogMasuk tbody'), tbK = document.querySelector('#tblLogKeluar tbody'); if (tbM) tbM.innerHTML = ''; if (tbK) tbK.innerHTML = ''; DB.logs.forEach(l => { const row = `<tr><td>${l.date}</td><td>${l.name}</td><td>${l.merk || '-'}</td><td style="color:${l.type === 'Masuk' ? '#28a745' : '#e94560'}; font-weight:bold;">${l.type === 'Masuk' ? '+' : '-'}${l.qty}</td><td>${(l.type === 'Masuk' ? l.note : l.dest) || '-'}</td></tr>`; if (l.type === 'Masuk' && tbM) tbM.innerHTML += row; else if (tbK) tbK.innerHTML += row; }); updateOrderTable(); }

        // ==================== BAGIAN 6: INISIALISASI & NAVIGASI UTAMA ====================
        async function navigate(pageId, el) { 
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active')); 
            document.getElementById(pageId).classList.add('active'); 
            document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active')); 
            if (el) el.classList.add('active'); 
            
            // Sembunyikan sidebar setelah menu diklik di mobile
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
            }

            renderCharts(pageId); 
            await updateTables(); 
            if (pageId === 'barangMasuk') { document.getElementById('barangMasuk').querySelector('form').reset(); showItemInfo(); } 
            if (pageId === 'barangKeluar') { document.getElementById('barangKeluar').querySelector('form').reset(); showItemPreview(); } 
            if (pageId === 'daftarBarang') loadPeriodData(); 
            if (pageId === 'laporan') generateReport(); 
        }
        async function handleLogin(e) {
            e.preventDefault();
            if(JSONBIN_BIN_ID) JSONBIN_API_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'flex';
            await loadFromCloud();
            const now = new Date();
            document.getElementById('inDate').value = now.toISOString().split('T')[0];
            document.getElementById('outDate').value = now.toISOString().split('T')[0];
            document.getElementById('repMonth').value = now.getMonth();
            document.getElementById('repYear').value = now.getFullYear();
            let pm = now.getMonth() - 1, py = now.getFullYear();
            if (pm < 0) { pm = 11; py--; }
            document.getElementById('periodMonth').value = pm;
            document.getElementById('periodYear').value = py;
            await updateTables();
            renderCharts('dashboard');
            loadPeriodData();
            generateReport();
        }
        function handleLogout() { if (confirm('Logout?')) location.reload(); }
        document.getElementById('inName')?.addEventListener('input', showItemInfo);
    </script>
</body>
</html>