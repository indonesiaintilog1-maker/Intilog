<!DOCTYPE html>
<html lang="id">
<head>
<meta name="referrer" content="no-referrer">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT. INTILOG INDONESIA - Cloud Inventory System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-body: #0f172a;
            --bg-sidebar: #0f172a;
            --bg-card: #1e293b;
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --text-cyan: #22d3ee;
            --primary: #8b5cf6;
            --primary-grad: linear-gradient(90deg, #8b5cf6 0%, #d946ef 100%);
            --border: #334155;
            --card-purple: linear-gradient(135deg, #a855f7 0%, #d946ef 100%);
            --card-blue: #3b82f6;
            --card-green: #22c55e;
            --card-orange: #fbbf24;
            --radius: 16px;
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR (FULL SCROLL) --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-right: 1px solid var(--border);
            flex-shrink: 0;
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
            height: 100%;
            overflow-y: auto; 
            overflow-x: hidden;
        }

        .sidebar::-webkit-scrollbar { width: 5px; }
        .sidebar::-webkit-scrollbar-track { background: transparent; }
        .sidebar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .sidebar::-webkit-scrollbar-thumb:hover { background: #475569; }

        .menu-container { margin-bottom: 20px; }

        .hamburger-btn {
            display: none; 
            background: none; border: none; color: var(--text-main);
            font-size: 1.5rem; cursor: pointer; margin-right: 15px;
            padding: 5px;
        }

        .sidebar-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            backdrop-filter: blur(2px);
        }

        /* --- RESPONSIVE LOGIC --- */
        @media (max-width: 768px) {
            .hamburger-btn { display: block; }
            .sidebar { position: fixed; top: 0; left: 0; transform: translateX(-100%); border-right: 1px solid var(--border); box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .main-content { padding: 15px; width: 100%; }
            .stats-grid { grid-template-columns: 1fr 1fr !important; }
            .unit-grid, .settings-grid, .form-grid, .bottom-grid { grid-template-columns: 1fr !important; }
            .search-bar { width: 100% !important; }
            .action-bar { flex-direction: column; }
        }

        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr !important; }
        }

        .sidebar-header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .org-logo { width: 190px; height: 95px; object-fit: contain; margin-bottom: 10px; background: white; padding: 5px; border-radius: 4px; }
        .org-name { font-weight: 800; font-size: 0.9rem; letter-spacing: 0.5px; }

        .menu-item {
            display: flex; align-items: center; padding: 12px 20px; margin-bottom: 8px;
            color: var(--text-muted); text-decoration: none; border-radius: 12px; font-weight: 500; transition: 0.3s;
        }
        .menu-item i { width: 25px; font-size: 1.1rem; }
        .menu-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .menu-item.active { background: var(--primary-grad); color: white; font-weight: 600; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); }

        .submenu-container { padding-left: 10px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px; }
        .submenu-item {
            padding: 8px 15px 8px 45px; color: var(--text-muted); font-size: 0.85rem;
            text-decoration: none; border-radius: 8px; display: flex; justify-content: space-between;
        }
        .submenu-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .submenu-item.active-sub { color: var(--text-cyan); font-weight: 600; background: rgba(34, 211, 238, 0.1); }
        .badge-count { background: #334155; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; }
        .top-bar { display: flex; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 1.8rem; font-weight: 700; flex-grow: 1; }
        .user-profile { background: var(--bg-card); padding: 8px 20px 8px 8px; border-radius: 30px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border); }
        .user-avatar { width: 32px; height: 32px; background: #8b5cf6; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* --- DASHBOARD CARDS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { padding: 25px; border-radius: var(--radius); color: white; min-height: 160px; display: flex; flex-direction: column; justify-content: space-between; }
        .stat-card .icon-box { width: 45px; height: 45px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 15px; }
        .stat-card h3 { font-size: 2.5rem; font-weight: 700; line-height: 1; }
        .stat-card p { font-size: 0.95rem; font-weight: 500; opacity: 0.9; }
        .card-purple { background: var(--card-purple); }
        .card-blue { background: var(--card-blue); }
        .card-green { background: var(--card-green); }
        .card-orange { background: var(--card-orange); }

        /* --- SECTIONS --- */
        .section-card { background: var(--bg-card); border-radius: var(--radius); padding: 25px; margin-bottom: 30px; border: 1px solid var(--border); }
        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-size: 1.1rem; font-weight: 600; }
        .unit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .unit-card { background: #0f172a; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: flex-end; }
        .unit-count { font-size: 1.2rem; color: var(--text-cyan); font-weight: 700; }
        
        /* SETTINGS GRID */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .settings-list { max-height: 150px; overflow-y: auto; margin-top: 10px; }
        .settings-item { display: flex; justify-content: space-between; background: #0f172a; padding: 8px 12px; border-radius: 6px; margin-bottom: 5px; font-size: 0.9rem; align-items: center;}

        /* TABLES & BADGES */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; padding: 15px; color: var(--text-muted); border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 0.9rem; vertical-align: middle; }
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; }
        .bg-good { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .bg-bad { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .bg-warn { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }

        /* UI ELEMENTS */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; white-space: nowrap; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-primary { background: var(--primary); color: white; }
        .form-control { width: 100%; padding: 12px; background: #0f172a; border: 1px solid var(--border); color: white; border-radius: 8px; outline: none; }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-card); width: 700px; max-width: 90%; padding: 30px; border-radius: var(--radius); max-height: 90vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-full { grid-column: 1 / -1; }
        label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px; display: block; }

        /* Page Sections */
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.3s; }
        .search-bar { display: flex; align-items: center; background: var(--bg-card); border: 1px solid var(--border); padding: 0 15px; border-radius: 8px; width: 300px; }
        .search-bar input { border: none; background: transparent; color: white; padding: 10px; width: 100%; outline: none; }
        .action-bar { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }

        /* TOASTER NOTIFICATION */
        #toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 3000;
        }
        .toast {
            background: #1e293b; color: white; padding: 12px 20px; border-radius: 8px;
            margin-top: 10px; border: 1px solid var(--border); box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease-out;
        }
        .toast.success i { color: #22c55e; }
        .toast.error i { color: #ef4444; }
        .toast.loading i { color: #fbbf24; animation: spin 1s linear infinite; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container"></div>

    <!-- SIDEBAR OVERLAY -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="https://placehold.co/190x95/ffffff/000000?text=INTILOG" alt="Logo" class="org-logo" id="sidebar-logo-img">
            <div class="org-name" id="sidebar-org-text">PT. INTILOG INDONESIA</div>
        </div>

        <!-- MENU CONTAINER -->
        <div class="menu-container">
            <a href="#" class="menu-item active" onclick="nav('dashboard', this)">
                <i class="fa-solid fa-chart-pie"></i> Dashboard
            </a>
            <a href="#" class="menu-item" id="menu-inv" onclick="nav('inventory', this, 'all')">
                <i class="fa-solid fa-boxes-stacked"></i> Inventory
                <i class="fa-solid fa-chevron-down" style="margin-left: auto; font-size: 0.8rem;"></i>
            </a>
            <div id="submenu-units" class="submenu-container"></div>
            <a href="#" class="menu-item" onclick="nav('history', this)">
                <i class="fa-solid fa-clock-rotate-left"></i> Riwayat
            </a>
            <a href="#" class="menu-item" onclick="nav('reports', this)">
                <i class="fa-solid fa-file-invoice"></i> Laporan
            </a>
            <a href="#" class="menu-item" onclick="nav('settings', this)">
                <i class="fa-solid fa-gear"></i> Pengaturan
            </a>
        </div>
        
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); font-size: 0.7rem; color: var(--text-muted); text-align: center;">
            Server Status: <span id="server-status" style="color: #fbbf24;">Connecting...</span>
        </div>
    </aside>

    <!-- CONTENT -->
    <main class="main-content">
        <div class="top-bar">
            <button class="hamburger-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
            <h1 class="page-title" id="page-header">Dashboard</h1>
            <div class="user-profile">
                <div class="user-avatar"><i class="fa-solid fa-user"></i></div>
                <span style="font-size: 0.9rem; font-weight: 600; display: none;">Admin</span>
            </div>
        </div>

        <!-- 1. DASHBOARD -->
        <section id="dashboard" class="page-section active">
            <div class="stats-grid">
                <div class="stat-card card-purple">
                    <div class="icon-box"><i class="fa-solid fa-layer-group"></i></div>
                    <h3 id="stat-types">0</h3><p>Total Jenis</p><div style="font-size:0.8rem; margin-top:5px;" id="stat-units-total">0 unit</div>
                </div>
                <div class="stat-card card-blue">
                    <div class="icon-box"><i class="fa-regular fa-building"></i></div>
                    <h3 id="stat-unit-count">0</h3><p>Unit Kerja</p>
                </div>
                <div class="stat-card card-green">
                    <div class="icon-box"><i class="fa-solid fa-circle-check"></i></div>
                    <h3 id="stat-good">0</h3><p>Kondisi Baik</p>
                </div>
                <div class="stat-card card-orange">
                    <div class="icon-box"><i class="fa-solid fa-screwdriver-wrench"></i></div>
                    <h3 id="stat-bad">0</h3><p>Perlu Perbaikan</p>
                </div>
            </div>
            <div class="section-card">
                <div class="section-header"><i class="fa-regular fa-building" style="color: #8b5cf6;"></i> Ringkasan Per Unit</div>
                <div class="unit-grid" id="dashboard-unit-grid"></div>
            </div>
            <div class="section-card">
                <div class="section-header"><i class="fa-solid fa-clock-rotate-left" style="color: #8b5cf6;"></i> Aktivitas Terbaru</div>
                <div class="table-responsive">
                    <table id="dash-history-table"><tbody style="color: #94a3b8; font-size: 0.9rem;"></tbody></table>
                </div>
            </div>
        </section>

        <!-- 2. INVENTORY -->
        <section id="inventory" class="page-section">
            <div class="section-card" style="border:none;">
                <div class="action-bar">
                    <div class="search-bar">
                        <i class="fa-solid fa-search" style="color: #64748b;"></i>
                        <input type="text" id="search-input" placeholder="Cari barang...">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" style="background: #334155; color: #fff;" onclick="loadDataFromCloud()"><i class="fa-solid fa-rotate-right"></i> Refresh Cloud</button>
                        <button class="btn btn-primary" onclick="openModal()"><i class="fa-solid fa-plus"></i> Tambah Barang</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>NO. INV</th>
                                <th>NAMA BARANG / DETAIL</th>
                                <th>UNIT</th>
                                <th>JUMLAH</th>
                                <th>KONDISI</th>
                                <th>STATUS</th>
                                <th>AKSI</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 3. SETTINGS -->
        <section id="settings" class="page-section">
            <div class="section-card">
                <div class="section-header">Identitas Organisasi</div>
                <form id="settings-form">
                    <label>Nama Organisasi</label>
                    <input type="text" id="set-org-name" class="form-control" style="margin-bottom:10px;">
                    <label>Logo (File Image)</label>
                    <input type="file" id="set-logo-file" class="form-control" style="margin-bottom:15px;">
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </form>
            </div>

            <div class="settings-grid">
                <div class="section-card">
                    <div class="section-header">Unit / Divisi</div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="new-unit-name" class="form-control" placeholder="Nama Unit">
                        <button class="btn btn-primary" onclick="addConfig('unit')"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div id="list-unit" class="settings-list"></div>
                </div>
                <div class="section-card">
                    <div class="section-header">Kategori Barang</div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="new-cat-name" class="form-control" placeholder="Kategori">
                        <button class="btn btn-primary" onclick="addConfig('cat')"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div id="list-cat" class="settings-list"></div>
                </div>
                <div class="section-card">
                    <div class="section-header">Satuan (UOM)</div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="new-uom-name" class="form-control" placeholder="Satuan">
                        <button class="btn btn-primary" onclick="addConfig('uom')"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div id="list-uom" class="settings-list"></div>
                </div>
                <div class="section-card">
                    <div class="section-header">Kondisi Fisik</div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="new-cond-name" class="form-control" placeholder="Kondisi">
                        <button class="btn btn-primary" onclick="addConfig('cond')"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div id="list-cond" class="settings-list"></div>
                </div>
                <div class="section-card">
                    <div class="section-header">Status Ketersediaan</div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="new-status-name" class="form-control" placeholder="Status">
                        <button class="btn btn-primary" onclick="addConfig('status')"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div id="list-status" class="settings-list"></div>
                </div>
            </div>
        </section>

        <!-- 4. RIWAYAT & LAPORAN -->
        <section id="history" class="page-section">
            <div class="section-card">
                <div class="section-header">Riwayat Lengkap <button class="btn btn-sm btn-primary" style="background:#ef4444; margin-left:auto;" onclick="clearHistory()">Hapus</button></div>
                <div class="table-responsive">
                    <table><thead><tr><th>Waktu</th><th>Aksi</th><th>Item</th><th>Ket</th></tr></thead><tbody id="full-history-body"></tbody></table>
                </div>
            </div>
        </section>
        
        <section id="reports" class="page-section">
            <div class="section-card">
                <div class="section-header">Pusat Laporan & Data</div>
                
                <!-- Exports & PRINT BUTTON -->
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="exportPDF('all')">PDF Semua Data</button>
                    <button class="btn btn-primary" style="background:#fbbf24; color:#000" onclick="exportPDF('rusak')">PDF Barang Rusak</button>
                    <!-- TOMBOL CETAK BARU -->
                    <button class="btn btn-primary" style="background:#f1f5f9; color:#0f172a; border: 1px solid #cbd5e1;" onclick="printReport()"><i class="fa-solid fa-print"></i> Cetak Laporan</button>
                </div>

                <!-- PDF per Unit -->
                <div style="margin-bottom: 20px; padding-top:15px; border-top:1px solid var(--border);">
                    <label>Export PDF per Unit</label>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <select id="report-unit-select" class="form-control" style="width:200px;"></select>
                        <button class="btn btn-primary" onclick="exportPDF('unit')">Download PDF</button>
                    </div>
                </div>

                <!-- Config Signer -->
                <div style="margin-bottom: 20px; padding-top:15px; border-top:1px solid var(--border);">
                    <label>Nama Penandatangan Laporan</label>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <input type="text" id="report-signer-name" class="form-control" placeholder="Nama Pembuat Laporan" style="width:200px;">
                        <button class="btn btn-primary" onclick="saveSigner()">Simpan</button>
                    </div>
                </div>

                <!-- JSON Backup/Restore -->
                <div style="padding-top:15px; border-top:1px solid var(--border);">
                    <label>Backup & Restore Database</label>
                    <div style="display:flex; gap:10px; margin-top:5px; flex-wrap: wrap;">
                        <button class="btn btn-primary" style="background:#22d3ee; color:#000" onclick="exportJSON()"><i class="fa-solid fa-download"></i> Export JSON</button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- MODAL FORM -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h3>Form Data Barang</h3>
                <i class="fa-solid fa-xmark" style="cursor: pointer;" onclick="closeModal()"></i>
            </div>
            <form id="itemForm">
                <input type="hidden" id="item-id">
                <div class="form-grid">
                    <div><label>No. Inv</label><input type="text" id="f-inv" class="form-control" required></div>
                    <div><label>Tanggal</label><input type="date" id="f-date" class="form-control" required></div>
                    <div><label>Nama Barang</label><input type="text" id="f-name" class="form-control" required></div>
                    <div><label>Model/Type</label><input type="text" id="f-model" class="form-control"></div>
                    <div><label>No. Seri</label><input type="text" id="f-serial" class="form-control"></div>
                    <div><label>Merk</label><input type="text" id="f-brand" class="form-control"></div>
                    <div><label>Unit / Divisi</label><select id="f-unit" class="form-control" required></select></div>
                    <div><label>Kategori</label><select id="f-cat" class="form-control"></select></div>
                    <div><label>Jumlah</label><input type="number" id="f-qty" class="form-control" value="1" min="1"></div>
                    <div><label>Satuan</label><select id="f-uom" class="form-control"></select></div>
                    <div><label>Kondisi</label><select id="f-cond" class="form-control"></select></div>
                    <div><label>Status</label><select id="f-status" class="form-control"></select></div>
                    <div><label>Lokasi</label><input type="text" id="f-loc" class="form-control"></div>
                    <div class="form-full"><label>Keterangan</label><textarea id="f-notes" class="form-control" rows="2"></textarea></div>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <button type="submit" class="btn btn-primary">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==========================================
        //  KONFIGURASI JSONBIN.IO (WAJIB DIISI)
        // ==========================================
        const BIN_ID = '693d4e35ae596e708f972dc6';
        const API_KEY = '$2a$10$x5GwuKvse0EbdK3Vvlw4wOG9ciW/nG/swhgglFMlQwbXSj3vArGle'; 
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}/latest`;

        // ==========================================
        //  UI HELPERS (TOAST NOTIFICATION)
        // ==========================================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fa-check';
            if (type === 'error') icon = 'fa-circle-xmark';
            if (type === 'loading') icon = 'fa-spinner';

            toast.innerHTML = `<i class="fa-solid ${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);

            if (type !== 'loading') {
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
            return toast; // Return element so we can remove loading toasts manually
        }

        function updateServerStatus(status, color) {
            const el = document.getElementById('server-status');
            el.innerText = status;
            el.style.color = color;
        }

        // ==========================================
        //  CLOUD SYNC FUNCTIONS
        // ==========================================
        async function loadDataFromCloud() {
            const toast = showToast('Mengambil data dari server...', 'loading');
            updateServerStatus("Syncing...", "#fbbf24");
            
            try {
                if(BIN_ID === 'MASUKKAN_BIN_ID_DISINI') {
                    throw new Error("BIN ID Belum diisi di Script!");
                }

                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: { 'X-Master-Key': API_KEY }
                });

                if (!response.ok) throw new Error("Gagal mengambil data");

                const result = await response.json();
                const record = result.record;

                // Update variables from cloud data
                if (record.items) items = record.items;
                if (record.lists) lists = record.lists;
                if (record.config) config = record.config;
                if (record.history) history = record.history;

                // Save to local for cache
                saveToLocal(); 
                
                // Refresh UI
                applyConfig();
                renderSidebarUnits();
                renderSettingsLists();
                updateDashboard();
                renderTable();
                renderHistory();
                fillSelectOptions();

                toast.remove();
                showToast('Data berhasil dimuat!', 'success');
                updateServerStatus("Online", "#22c55e");

            } catch (error) {
                console.error(error);
                toast.remove();
                showToast(error.message, 'error');
                updateServerStatus("Offline (Local Mode)", "#ef4444");
            }
        }

        async function saveToCloud() {
            // Prepare payload
            const payload = {
                items: items,
                lists: lists,
                config: config,
                history: history
            };

            updateServerStatus("Saving...", "#fbbf24");
            // Kami tidak menampilkan toast loading untuk save agar tidak mengganggu, 
            // tapi bisa dilihat di status bar sidebar.

            try {
                if(BIN_ID === 'MASUKKAN_BIN_ID_DISINI') return; // Skip if no config

                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("Gagal menyimpan ke server");
                
                showToast('Data tersimpan di Cloud', 'success');
                updateServerStatus("Online (Synced)", "#22c55e");

            } catch (error) {
                console.error(error);
                showToast('Gagal simpan ke Cloud (Tersimpan Lokal)', 'error');
                updateServerStatus("Sync Failed", "#ef4444");
            }
        }

        // ==========================================
        //  STANDARD LOGIC
        // ==========================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        function closeSidebarOnMobile() {
            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebar-overlay').classList.remove('active');
            }
        }

        // --- DATA MANAGEMENT ---
        const defaults = {
            orgName: 'PT. INTILOG INDONESIA', logo: '', signerName: 'Administrator',
            lists: {
                unit: [{id:'u1', name:'Unit I'}, {id:'u2', name:'Unit II'}],
                cat: ['Elektronik', 'Furniture', 'Kendaraan', 'Mesin'],
                uom: ['Unit', 'Pcs', 'Set', 'Buah'],
                cond: ['Baik', 'Rusak Ringan', 'Rusak Berat'],
                status: ['Tersedia', 'Digunakan', 'Dipinjam', 'Hilang']
            }
        };

        // Load Initial from LocalStorage (Fast Load) then try Cloud
        let config = JSON.parse(localStorage.getItem('inv_config')) || { orgName: defaults.orgName, logo: '', signerName: defaults.signerName };
        if(!config.signerName) config.signerName = defaults.signerName;

        let lists = JSON.parse(localStorage.getItem('inv_lists')) || defaults.lists;
        let items = JSON.parse(localStorage.getItem('inv_items')) || [];
        let history = JSON.parse(localStorage.getItem('inv_history')) || [];
        
        let currentFilter = 'all';

        function init() {
            // Render UI immediately using local data
            applyConfig();
            renderSidebarUnits();
            renderSettingsLists();
            updateDashboard();
            renderTable();
            renderHistory();
            fillSelectOptions();
            
            // Try to sync with cloud
            setTimeout(loadDataFromCloud, 1000); 
        }

        function saveToLocal() {
            localStorage.setItem('inv_items', JSON.stringify(items));
            localStorage.setItem('inv_lists', JSON.stringify(lists));
            localStorage.setItem('inv_config', JSON.stringify(config));
            localStorage.setItem('inv_history', JSON.stringify(history));
        }

        function saveAllData() {
            saveToLocal(); // Save locally first (Instant)
            saveToCloud(); // Then push to server
            renderTable();
            updateDashboard();
            renderSidebarUnits();
            renderHistory();
        }

        function applyConfig() {
            document.getElementById('sidebar-org-text').innerText = config.orgName;
            document.getElementById('set-org-name').value = config.orgName;
            document.getElementById('report-signer-name').value = config.signerName;
            if(config.logo) document.getElementById('sidebar-logo-img').src = config.logo;
        }

        window.saveSigner = function() {
            config.signerName = document.getElementById('report-signer-name').value;
            saveAllData();
        }

        // --- CONFIG LISTS ---
        function renderSettingsLists() {
            renderList('unit', 'list-unit'); renderList('cat', 'list-cat'); renderList('uom', 'list-uom'); renderList('cond', 'list-cond'); renderList('status', 'list-status');
        }
        function renderList(key, elemId) {
            const el = document.getElementById(elemId); el.innerHTML = '';
            lists[key].forEach((item, idx) => {
                const val = (typeof item === 'object') ? item.name : item;
                const id = (typeof item === 'object') ? item.id : idx;
                el.innerHTML += `<div class="settings-item"><span>${val}</span><i class="fa-solid fa-trash" style="color:#ef4444; cursor:pointer;" onclick="removeConfig('${key}', '${id}')"></i></div>`;
            });
        }
        window.addConfig = function(key) {
            const inputs = { unit:'new-unit-name', cat:'new-cat-name', uom:'new-uom-name', cond:'new-cond-name', status:'new-status-name' };
            const val = document.getElementById(inputs[key]).value;
            if(!val) return;
            if(key === 'unit') lists.unit.push({ id: 'u'+Date.now(), name: val }); else lists[key].push(val);
            saveAllData(); 
            document.getElementById(inputs[key]).value = '';
            renderSettingsLists(); fillSelectOptions();
        }
        window.removeConfig = function(key, id) {
            if(!confirm('Hapus item ini?')) return;
            if(key === 'unit') lists.unit = lists.unit.filter(u => u.id !== id); else lists[key] = lists[key].filter((_, idx) => idx != id);
            saveAllData();
            renderSettingsLists(); fillSelectOptions();
        }
        
        function fillSelectOptions() {
            const fill = (id, arr) => {
                const el = document.getElementById(id); el.innerHTML = '';
                arr.forEach(i => el.innerHTML += `<option value="${typeof i==='object'?i.id:i}">${typeof i==='object'?i.name:i}</option>`);
            };
            fill('f-unit', lists.unit); fill('report-unit-select', lists.unit); fill('f-cat', lists.cat); fill('f-uom', lists.uom); fill('f-cond', lists.cond); fill('f-status', lists.status);
        }

        // --- MAIN LOGIC ---
        window.nav = function(pageId, el, filter = null) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.getElementById('page-header').innerText = pageId.charAt(0).toUpperCase() + pageId.slice(1);
            
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.querySelectorAll('.submenu-item').forEach(s => s.classList.remove('active-sub'));

            if(el.classList.contains('submenu-item')) {
                document.getElementById('menu-inv').classList.add('active');
                el.classList.add('active-sub');
            } else { el.classList.add('active'); }

            if(pageId === 'inventory') {
                currentFilter = filter; renderTable();
                document.getElementById('page-header').innerText = filter === 'all' ? 'Inventory' : 'Inventory - ' + lists.unit.find(u=>u.id===filter).name;
            }
            if(pageId === 'dashboard') updateDashboard();
            closeSidebarOnMobile();
        }

        function renderSidebarUnits() {
            const div = document.getElementById('submenu-units'); div.innerHTML = '';
            lists.unit.forEach(u => {
                const count = items.filter(i => i.unit === u.id).length;
                const activeClass = (currentFilter === u.id) ? 'active-sub' : '';
                div.innerHTML += `<a class="submenu-item ${activeClass}" onclick="nav('inventory', this, '${u.id}')"><span><i class="fa-solid fa-folder"></i> ${u.name}</span><span class="badge-count">${count}</span></a>`;
            });
        }

        function updateDashboard() {
            document.getElementById('stat-types').innerText = items.length;
            document.getElementById('stat-units-total').innerText = items.reduce((s, i) => s + parseInt(i.qty), 0) + " unit";
            document.getElementById('stat-unit-count').innerText = lists.unit.length;
            document.getElementById('stat-good').innerText = items.filter(i => i.cond === 'Baik').reduce((s, i) => s + parseInt(i.qty), 0);
            document.getElementById('stat-bad').innerText = items.filter(i => i.cond !== 'Baik').reduce((s, i) => s + parseInt(i.qty), 0);

            const uGrid = document.getElementById('dashboard-unit-grid'); uGrid.innerHTML = '';
            lists.unit.forEach(u => {
                const uItems = items.filter(i => i.unit === u.id);
                uGrid.innerHTML += `<div class="unit-card"><div><span style="font-weight:600; display:block; margin-bottom:5px;">${u.name}</span><span style="font-size:1.2rem; color:var(--text-cyan); font-weight:700;">${uItems.reduce((s, i) => s + parseInt(i.qty), 0)} unit</span></div><span style="font-size:0.8rem; color:var(--text-muted);">${uItems.length} jenis</span></div>`;
            });

            const tHist = document.getElementById('dash-history-table').querySelector('tbody'); tHist.innerHTML = '';
            history.slice(0, 5).forEach(h => tHist.innerHTML += `<tr><td style="padding:10px 0;">${h.date}</td><td style="padding:10px 0;">${h.action}</td><td style="padding:10px 0; color:white;">${h.item}</td></tr>`);
        }

        function renderTable() {
            const tbody = document.getElementById('inventory-table-body'); tbody.innerHTML = '';
            let filtered = currentFilter === 'all' ? items : items.filter(i => i.unit === currentFilter);
            const search = document.getElementById('search-input').value.toLowerCase();
            if(search) filtered = filtered.filter(i => i.name.toLowerCase().includes(search) || i.model?.toLowerCase().includes(search) || i.serial?.toLowerCase().includes(search));

            filtered.forEach(i => {
                const uName = lists.unit.find(u => u.id === i.unit)?.name || '-';
                let bg = i.cond === 'Baik' ? 'bg-good' : 'bg-bad';
                let detail = `<b>${i.name}</b>`;
                if(i.model || i.serial) detail += `<br><small style="color:#94a3b8;">${i.model || ''} ${i.serial ? '| SN:'+i.serial : ''}</small>`;

                tbody.innerHTML += `
                    <tr>
                        <td style="color:#22d3ee;">${i.noInv}</td>
                        <td>${detail}</td>
                        <td>${uName}</td>
                        <td><b>${i.qty}</b> <small>${i.uom}</small></td>
                        <td><span class="badge ${bg}">${i.cond}</span></td>
                        <td>${i.status}</td>
                        <td>
                            <button class="btn" style="background:#1e293b; color:#22d3ee; padding:5px 10px;" onclick="copyItem(${i.id})" title="Copy"><i class="fa-regular fa-copy"></i></button>
                            <button class="btn" style="background:#1e293b; color:#22d3ee; padding:5px 10px;" onclick="editItem(${i.id})" title="Edit"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn" style="background:#1e293b; color:#ef4444; padding:5px 10px;" onclick="deleteItem(${i.id})" title="Delete"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        // --- FORM & CRUD ---
        const modal = document.getElementById('modal'); const form = document.getElementById('itemForm');
        window.openModal = function() { modal.style.display = 'flex'; form.reset(); document.getElementById('item-id').value = ''; if(currentFilter!=='all') document.getElementById('f-unit').value = currentFilter; }
        window.closeModal = function() { modal.style.display = 'none'; }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('item-id').value;
            const obj = {
                id: id ? parseInt(id) : Date.now(),
                noInv: document.getElementById('f-inv').value,
                date: document.getElementById('f-date').value,
                name: document.getElementById('f-name').value,
                model: document.getElementById('f-model').value,
                serial: document.getElementById('f-serial').value,
                brand: document.getElementById('f-brand').value,
                unit: document.getElementById('f-unit').value,
                cat: document.getElementById('f-cat').value,
                qty: document.getElementById('f-qty').value,
                uom: document.getElementById('f-uom').value,
                cond: document.getElementById('f-cond').value,
                status: document.getElementById('f-status').value,
                loc: document.getElementById('f-loc').value,
                notes: document.getElementById('f-notes').value
            };

            if(id) { items[items.findIndex(x => x.id == id)] = obj; addLog('Edit', obj.name, 'Update'); }
            else { items.push(obj); addLog('Tambah', obj.name, 'Input'); }
            
            saveAllData(); 
            closeModal();
        });

        window.editItem = function(id) {
            const i = items.find(x => x.id == id);
            document.getElementById('item-id').value = i.id;
            document.getElementById('f-inv').value = i.noInv;
            document.getElementById('f-date').value = i.date;
            document.getElementById('f-name').value = i.name;
            document.getElementById('f-model').value = i.model || '';
            document.getElementById('f-serial').value = i.serial || '';
            document.getElementById('f-brand').value = i.brand || '';
            document.getElementById('f-unit').value = i.unit;
            document.getElementById('f-cat').value = i.cat;
            document.getElementById('f-qty').value = i.qty;
            document.getElementById('f-uom').value = i.uom;
            document.getElementById('f-cond').value = i.cond;
            document.getElementById('f-status').value = i.status;
            document.getElementById('f-loc').value = i.loc;
            document.getElementById('f-notes').value = i.notes || '';
            modal.style.display = 'flex';
        }

        window.copyItem = function(id) {
            const i = items.find(x => x.id == id);
            document.getElementById('item-id').value = ''; 
            document.getElementById('f-inv').value = ''; 
            document.getElementById('f-date').value = i.date;
            document.getElementById('f-name').value = i.name;
            document.getElementById('f-model').value = i.model || '';
            document.getElementById('f-serial').value = i.serial || '';
            document.getElementById('f-brand').value = i.brand || '';
            document.getElementById('f-unit').value = i.unit; 
            document.getElementById('f-cat').value = i.cat;
            document.getElementById('f-qty').value = i.qty;
            document.getElementById('f-uom').value = i.uom;
            document.getElementById('f-cond').value = i.cond;
            document.getElementById('f-status').value = i.status;
            document.getElementById('f-loc').value = i.loc;
            document.getElementById('f-notes').value = i.notes || '';
            document.getElementById('f-name').value = i.name + ' (Copy)';
            modal.style.display = 'flex';
        }

        window.deleteItem = function(id) {
            if(confirm('Hapus item?')) { 
                items = items.filter(x => x.id != id); 
                saveAllData(); 
            }
        }

        function addLog(action, item, desc) { 
            history.unshift({ date: new Date().toLocaleDateString('id-ID'), action, item, desc }); 
            // Tidak perlu save disini karena biasanya dipanggil sebelum saveAllData
        }
        
        function renderHistory() { document.getElementById('full-history-body').innerHTML = history.map(h=>`<tr><td>${h.date}</td><td>${h.action}</td><td>${h.item}</td><td>${h.desc}</td></tr>`).join(''); }
        
        window.clearHistory = function() { 
            if(confirm('Clear?')) { history=[]; saveAllData(); } 
        }

        // --- EXPORT PDF ---
        window.exportPDF = function(type) {
            const { jsPDF } = window.jspdf; const doc = new jsPDF('l');
            const pw = doc.internal.pageSize.getWidth();
            const ph = doc.internal.pageSize.getHeight();
            
            let data = items, title = "Laporan Semua Aset";
            if(type==='unit') { const u = document.getElementById('report-unit-select').value; data=items.filter(i=>i.unit===u); title="Laporan "+lists.unit.find(x=>x.id===u).name; }
            else if(type==='rusak') { data=items.filter(i=>i.cond!=='Baik'); title="Laporan Kerusakan"; }
            
            // HEADER
            let startY = 15;
            if (config.logo && config.logo.startsWith('data:image')) {
                const logoWidth = 30; const logoX = (pw - logoWidth) / 2;
                doc.addImage(config.logo, 'PNG', logoX, 10, logoWidth, 15); startY += 20; 
            }

            doc.setFontSize(16); doc.setFont("helvetica", "bold"); 
            doc.text(config.orgName, pw / 2, startY, { align: 'center' }); startY += 7;
            doc.setFontSize(12); doc.setFont("helvetica", "normal"); 
            doc.text(title, pw / 2, startY, { align: 'center' }); startY += 6;
            doc.setFontSize(10); doc.setTextColor(100); 
            doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`, pw / 2, startY, { align: 'center' }); startY += 10;

            const rows = data.map(i => [i.noInv, i.date, i.name, (i.model||'')+' '+(i.serial||''), i.qty+' '+i.uom, i.cond, i.status, i.loc, i.notes||'']);
            
            doc.autoTable({ 
                head: [['No.Inv', 'Tgl', 'Nama', 'Model/SN', 'Jml', 'Kondisi', 'Status', 'Lokasi', 'Ket']], 
                body: rows, startY: startY,
                headStyles: { fillColor: [54, 153, 255], halign: 'center' },
                didDrawPage: function (data) {
                    doc.setFontSize(8); doc.setTextColor(0);
                    doc.text("Halaman " + doc.internal.getNumberOfPages(), pw - 15, 10, { align: 'right' });
                }
            });

            // SIGNATURE
            let finalY = doc.lastAutoTable.finalY + 15;
            if (finalY + 35 > ph) { doc.addPage(); finalY = 20; }
            
            const rightMargin = pw - 40;
            doc.setFontSize(10); doc.setTextColor(0);
            doc.text("Dibuat Oleh,", rightMargin, finalY, { align: 'center' });
            doc.text(`( ${config.signerName || 'Administrator'} )`, rightMargin, finalY + 25, { align: 'center' });

            doc.save('laporan.pdf');
        }

        // --- NEW PRINT FUNCTION ---
        window.printReport = function() {
            // Membuka jendela baru
            const printWindow = window.open('', '', 'width=900,height=600');
            
            let logoHtml = '';
            if (config.logo && config.logo.startsWith('data:image')) {
                logoHtml = `<img src="${config.logo}" style="max-height: 80px; margin-bottom: 10px;">`;
            }

            // Membangun baris tabel
            let rowsHtml = '';
            items.forEach((i, index) => {
                const uName = lists.unit.find(u => u.id === i.unit)?.name || '-';
                rowsHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${i.noInv}</td>
                        <td>${i.date}</td>
                        <td>${i.name}<br><small>${i.model || ''} ${i.serial || ''}</small></td>
                        <td>${uName}</td>
                        <td>${i.qty} ${i.uom}</td>
                        <td>${i.cond}</td>
                        <td>${i.loc || '-'}</td>
                    </tr>
                `;
            });

            // HTML Struktur Halaman Cetak
            const htmlContent = `
                <html>
                <head>
                    <title>Cetak Laporan - ${config.orgName}</title>
                    <style>
                        body { font-family: sans-serif; font-size: 12px; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { margin: 5px 0; font-size: 18px; text-transform: uppercase; }
                        .header h2 { margin: 0; font-size: 14px; font-weight: normal; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        th, td { border: 1px solid #000; padding: 6px 8px; text-align: left; vertical-align: top; }
                        th { background-color: #f2f2f2; text-align: center; font-weight: bold; }
                        .signature { float: right; margin-top: 50px; text-align: center; width: 200px; page-break-inside: avoid; }
                        .footer { margin-top: 30px; font-size: 10px; color: #666; text-align: center; }
                        @media print {
                            @page { margin: 1cm; size: landscape; }
                            button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        ${logoHtml}
                        <h1>${config.orgName}</h1>
                        <h2>Laporan Data Aset & Inventaris</h2>
                        <p>Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}</p>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th width="30">No</th>
                                <th>No. Inventaris</th>
                                <th>Tanggal</th>
                                <th>Nama Barang / Spesifikasi</th>
                                <th>Unit</th>
                                <th>Jml</th>
                                <th>Kondisi</th>
                                <th>Lokasi</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHtml}
                        </tbody>
                    </table>

                    <div class="signature">
                        <p>Dibuat Oleh,</p>
                        <br><br><br>
                        <p style="font-weight: bold; text-decoration: underline;">${config.signerName}</p>
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Tunggu gambar load jika ada, lalu print
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
                // printWindow.close(); // Opsional: tutup otomatis setelah print
            }, 500);
        }
        
        window.exportJSON = function() {
            const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({items, lists, config, history}));
            a.download = 'backup.json'; a.click();
        }

        document.getElementById('settings-form').addEventListener('submit', (e) => {
            e.preventDefault();
            config.orgName = document.getElementById('set-org-name').value;
            const f = document.getElementById('set-logo-file');
            if(f.files[0]) { 
                const r = new FileReader(); 
                r.onload=(ev)=>{ 
                    config.logo=ev.target.result; 
                    saveAllData(); 
                    applyConfig(); 
                }; 
                r.readAsDataURL(f.files[0]); 
            }
            else { 
                saveAllData(); 
                applyConfig(); 
            }
        });

        document.getElementById('search-input').addEventListener('input', renderTable);
        init();
    </script>
</body>
</html>