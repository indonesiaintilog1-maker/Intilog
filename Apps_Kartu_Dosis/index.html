<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadGuard Pro - ONLINE (v3.13 Orange NBD)</title>
    
    <!-- Tech Stack -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js Plugins -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        [x-cloak] { display: none !important; }
        .nav-item.active { background-color: #1e293b; color: #38bdf8; border-right: 3px solid #38bdf8; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .app-status-indicator {
            background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 1rem;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 95%; max-width: 1000px; max-height: 95vh;
            border-radius: 12px; overflow-y: auto; padding: 24px;
            position: relative;
        }

        /* PRINT FOOTER ELEMENT */
        #print-footer {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%;
            text-align: center; font-size: 10px; color: #64748b; padding: 5px;
            background: white; border-top: 1px solid #e2e8f0; z-index: 10000;
        }

        /* === PRINT STYLING === */
        @media print {
            @page { size: auto; margin: 10mm 10mm 15mm 10mm; }
            body { background: white; -webkit-print-color-adjust: exact; }
            
            aside, header, .no-print, .loading-overlay { display: none !important; }
            #print-footer { display: block !important; }

            /* Main Report Print */
            body:not(.printing-modal) main { display: block !important; height: auto !important; overflow: visible !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
            body:not(.printing-modal) .print-container { display: block !important; position: static !important; width: 100% !important; }
            body:not(.printing-modal) .modal-overlay { display: none !important; }

            /* Modal Archive Print */
            body.printing-modal main { display: none !important; } 
            body.printing-modal .modal-overlay { position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; height: auto !important; background: white !important; z-index: 10000 !important; display: block !important; }
            body.printing-modal .modal-content { position: static !important; width: 100% !important; max-width: 100% !important; height: auto !important; overflow: visible !important; box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; }
            body.printing-modal .no-print-modal { display: none !important; }
            
            .break-inside-avoid { break-inside: avoid; }
            tr { break-inside: avoid; }
            .print-grid-2 { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 1rem !important; }
        }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex" x-data="radGuardApp()" x-init="initApp()" :class="{'printing-modal': isPrintingModal}" style="height: 100dvh;">

    <!-- GLOBAL PRINT FOOTER -->
    <div id="print-footer">Developed by Meilody</div>

    <!-- Loading Overlay -->
    <div x-show="isLoading" class="loading-overlay" x-cloak>
        <div class="app-status-indicator">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-sky-600"></div>
            <div>
                <div class="font-semibold" x-text="loadingMessage">Memuat Data...</div>
                <div class="text-sm text-slate-600">Harap tunggu sebentar</div>
            </div>
        </div>
    </div>

    <!-- ================= MODAL (POPUP) ================= -->
    <div x-show="historyModalOpen" class="modal-overlay" x-cloak>
        <div class="modal-content" @click.away="historyModalOpen = false">
            <div class="flex justify-between items-start mb-2">
                <div></div> 
                <div class="flex flex-col items-end gap-2">
                    <button @click="historyModalOpen = false" class="p-2 hover:bg-slate-100 rounded-full no-print-modal"><i class="ph ph-x text-xl"></i></button>
                    <template x-if="appData.settings.orgLogo">
                        <img :src="appData.settings.orgLogo" class="h-14 object-contain mb-2">
                    </template>
                </div>
            </div>

            <div class="mb-6 pb-4 border-b">
                <h3 class="text-2xl font-bold text-slate-800" x-text="(historyMode === 'view' ? 'Detail Arsip ' : 'Edit Arsip ') + tempArchiveData?.year"></h3>
                <p class="text-sm text-slate-500 mt-1">Laporan Historis Data Radiasi</p>
            </div>
            
            <div class="space-y-6">
                <!-- Section: Data Pendose -->
                <div class="break-inside-avoid">
                    <h4 class="font-bold text-slate-700 mb-2">Data Pendose (Per Bulan)</h4>
                    <div class="border rounded-lg overflow-hidden">
                        <div class="overflow-y-auto" :class="{'max-h-60': !isPrintingModal}">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 text-left sticky top-0"><tr><th class="p-3">Bulan</th><th class="p-3 text-center">Mg I</th><th class="p-3 text-center">Mg II</th><th class="p-3 text-center">Mg III</th><th class="p-3 text-center">Mg IV</th><th class="p-3 text-right">Total</th></tr></thead>
                                <tbody class="divide-y">
                                    <template x-for="(m, mIdx) in tempArchiveData?.doseData" :key="mIdx">
                                        <tr>
                                            <td class="p-3 font-medium" x-text="m.name"></td>
                                            <template x-for="(w, wIdx) in m.weeks" :key="wIdx"><td class="p-1">
                                                <template x-if="historyMode === 'view'"><div class="text-center text-xs text-slate-600" x-text="w.mSv > 0 ? w.mSv.toFixed(3) : '-'"></div></template>
                                                <template x-if="historyMode === 'edit'"><div class="flex gap-1"><input type="number" step="0.01" x-model.number="w.start" placeholder="Awl" class="w-10 text-[10px] border rounded text-center p-1"><input type="number" step="0.01" x-model.number="w.end" placeholder="Akh" class="w-10 text-[10px] border rounded text-center p-1"></div></template>
                                            </td></template>
                                            <td class="p-3 text-right font-mono font-bold" x-text="calculateTempMonthTotal(m).toFixed(3)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Section: Evaluasi TLD -->
                <div class="break-inside-avoid">
                    <h4 class="font-bold text-slate-700 mb-2">Evaluasi TLD (Triwulan)</h4>
                    <div class="border rounded-lg overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 text-left"><tr><th class="p-3">Triwulan</th><th class="p-3">Periode</th><th class="p-3 text-right">Dosis (mSv)</th></tr></thead>
                            <tbody class="divide-y">
                                <template x-for="(val, idx) in tempArchiveData?.quarterManualDose" :key="idx">
                                    <tr>
                                        <td class="p-3 font-medium" x-text="romanize(idx + 1)"></td>
                                        <td class="p-3 text-slate-500 text-xs" x-text="getArchivePeriodLabel(idx)"></td>
                                        <td class="p-3 text-right"><template x-if="historyMode === 'view'"><span class="font-mono" x-text="val ? val.toFixed(3) : '-'"></span></template><template x-if="historyMode === 'edit'"><input type="number" step="0.001" x-model.number="tempArchiveData.quarterManualDose[idx]" class="border rounded p-1 w-24 text-right font-mono text-sm"></template></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Section: Signature -->
                <div class="mt-8 flex justify-end break-inside-avoid">
                    <div class="text-center w-48">
                        <p class="text-sm">Petugas Proteksi Radiasi (PPR)</p>
                        <p class="mt-12 font-semibold border-b border-slate-400 pb-1" x-text="appData.settings.pprName || ''"></p>
                        <p class="mt-1 text-xs" x-show="appData.settings.pprNib">No. SIB: <span x-text="appData.settings.pprNib"></span></p>
                    </div>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t flex justify-end gap-3 no-print-modal">
                <button @click="printModal()" class="px-4 py-2 bg-slate-800 hover:bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm flex items-center gap-2"><i class="ph ph-printer"></i> Cetak Arsip</button>
                <button @click="historyModalOpen = false" class="px-4 py-2 border rounded-lg hover:bg-slate-50 text-sm">Tutup</button>
                <template x-if="historyMode === 'edit'"><button @click="saveHistoryChanges()" class="px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white rounded-lg text-sm font-bold shadow-sm">Simpan Perubahan</button></template>
            </div>
        </div>
    </div>

    <!-- ================= SIDEBAR ================= -->
    <aside
        class="no-print w-64 bg-slate-900 text-slate-400 flex flex-col h-full flex-shrink-0 transition-all duration-300 z-50"
        :class="sidebarOpen ? 'translate-x-0' : '-translate-x-64 absolute lg:relative lg:translate-x-0'"
    >
        <div class="px-6 py-4 border-b border-slate-800 text-white flex flex-col items-center relative flex-shrink-0">
            <button @click="sidebarOpen = !sidebarOpen" class="absolute right-2 top-2 text-slate-400 hover:text-white lg:hidden"><i class="ph ph-list text-xl"></i></button>
            <div class="w-[200px] h-[120px] flex items-center justify-center overflow-hidden">
                <template x-if="appData.settings.orgLogo"><img :src="appData.settings.orgLogo" class="w-full h-full object-contain"></template>
                <template x-if="!appData.settings.orgLogo"><div class="w-full h-full flex items-center justify-center bg-slate-800 text-sky-500 font-bold text-sm">LOGO</div></template>
            </div>
            <div class="mt-2 text-center"><span class="font-bold text-base" x-text="appData.settings.orgName || 'Nama Organisasi'"></span></div>
        </div>
        
        <div class="p-6 border-b border-slate-800 flex-shrink-0">
            <template x-if="activeWorker">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center text-white font-bold text-sm">
                        <span x-text="getInitials(activeWorker.name)"></span>
                    </div>
                    <div>
                        <div class="text-sm font-bold text-white truncate w-32" x-text="activeWorker.name"></div>
                        <div class="text-xs text-slate-500" x-text="activeWorker.id_text"></div>
                    </div>
                </div>
            </template>
        </div>
        
        <nav class="flex-1 py-6 space-y-1 overflow-y-auto">
            <a href="#" @click.prevent="switchView('dashboard')" class="nav-item flex items-center gap-3 px-6 py-3 hover:bg-slate-800" :class="view === 'dashboard' && 'active'"><i class="ph ph-squares-four text-lg"></i><span>Dashboard</span></a>
            <a href="#" @click.prevent="switchView('input')" class="nav-item flex items-center gap-3 px-6 py-3 hover:bg-slate-800" :class="view === 'input' && 'active'"><i class="ph ph-pencil-simple-line text-lg"></i><span>Data Pendose</span></a>
            <a href="#" @click.prevent="switchView('tld')" class="nav-item flex items-center gap-3 px-6 py-3 hover:bg-slate-800" :class="view === 'tld' && 'active'"><i class="ph ph-chart-pie-slice text-lg"></i><span>Evaluasi TLD</span></a>
            <a href="#" @click.prevent="switchView('history')" class="nav-item flex items-center gap-3 px-6 py-3 hover:bg-slate-800" :class="view === 'history' && 'active'"><i class="ph ph-clock-counter-clockwise text-lg"></i><span>Riwayat</span></a>
            <a href="#" @click.prevent="switchView('report')" class="nav-item flex items-center gap-3 px-6 py-3 hover:bg-slate-800" :class="view === 'report' && 'active'"><i class="ph ph-file-text text-lg"></i><span>Laporan</span></a>
        </nav>

        <div class="p-4 border-t border-slate-800 flex-shrink-0">
            <a href="#" @click.prevent="switchView('settings')" class="nav-item flex items-center gap-3 px-4 py-2 mb-2 rounded hover:bg-slate-800" :class="view === 'settings' && 'bg-slate-800 text-white'">
                <i class="ph ph-gear text-lg"></i><span>Pengaturan</span>
            </a>
            <p class="text-center text-xs text-slate-500 mb-1">Application ver. 3.13</p>
            <p class="text-center text-xs text-slate-600">Developed by: Meilody</p>
        </div>
    </aside>

    <!-- ================= MAIN CONTENT ================= -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-50">
        <header class="no-print h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 lg:px-8 flex-shrink-0 relative">
            <div class="flex items-center gap-4">
                <button @click="sidebarOpen = !sidebarOpen" class="p-2 text-slate-600"><i class="ph ph-list text-2xl"></i></button>
                <div class="flex items-center gap-2" x-show="appData.workers.length > 0">
                    <label for="worker-select" class="text-sm font-medium text-slate-500">Pekerja:</label>
                    <select id="worker-select" x-model.number="activeWorkerId" @change="onWorkerChange" class="w-48 text-sm font-bold border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                        <template x-for="worker in appData.workers" :key="worker.id"><option :value="worker.id" x-text="worker.name"></option></template>
                    </select>
                </div>
            </div>
            <div class="hidden md:block absolute left-1/2 -translate-x-1/2 font-bold text-lg text-slate-800 tracking-wide uppercase">
                KARTU DOSIS RADIASI
            </div>
            <div class="text-sm text-slate-500 hidden md:block">
                <template x-if="activeWorker">
                    <span class="mr-4">Area: <span class="font-semibold text-slate-700" x-text="activeWorker.area"></span></span>
                </template>
                <span x-show="isSaving" class="ml-4 inline-flex items-center gap-1 text-xs text-sky-600" x-transition><div class="animate-spin rounded-full h-3 w-3 border-b-2 border-sky-600"></div>Menyimpan...</span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 lg:p-8 print-container">
            <template x-if="!activeWorker && !isLoading">
                <div class="text-center p-10 bg-white rounded-xl shadow-sm">
                    <h2 class="text-xl font-bold">Tidak ada data pekerja.</h2>
                    <p class="text-slate-500 mt-2">Silakan tambahkan pekerja baru di menu Pengaturan.</p>
                </div>
            </template>
            <div x-show="activeWorker" x-cloak>
                
                <!-- DASHBOARD -->
                <div x-show="view === 'dashboard'" class="no-print" x-transition.opacity>
                    <div class="space-y-6">
                        <div class="bg-slate-900 text-white rounded-2xl p-6 shadow-xl"><h3 class="text-lg font-bold mb-6">Monitoring NBD</h3>
                            <div class="space-y-5">
                                <!-- Tahunan NBD ORANGE -->
                                <div><div class="flex justify-between text-sm mb-1"><span class="font-semibold">Tahunan</span><span class="font-mono text-xs">Progres: <span x-text="stats.year.toFixed(3)"></span> mSv / NBD: 20 mSv</span></div><div class="flex items-center gap-3"><div class="flex-1"><div class="text-[10px] text-slate-400 mb-0.5">NBD 20 mSv</div><div class="h-3 bg-orange-900/20 rounded-full overflow-hidden"><div class="h-full bg-orange-500 w-full"></div></div></div><div class="flex-1"><div class="text-[10px] text-slate-400 mb-0.5">Progres (<span x-text="getPercent(stats.year, 20).toFixed(1)"></span>%)</div><div class="h-3 bg-slate-800 rounded-full overflow-hidden"><div class="h-full progress-bar rounded-full" :class="getBarColor(stats.year, 20)" :style="'width: ' + getPercent(stats.year, 20) + '%'"></div></div></div></div><div class="flex justify-between items-center text-xs mt-1"><span class="text-slate-400">Status:</span><span class="px-2 py-0.5 rounded-full font-semibold" :class="getStatusFromValue(stats.year, 20).badgeClass" x-text="getStatusFromValue(stats.year, 20).label"></span></div></div>
                                <!-- Triwulan NBD ORANGE -->
                                <div><div class="flex justify-between text-sm mb-2"><span class="font-semibold">Triwulan I â€“ IV</span><span class="text-xs text-slate-300">Setiap triwulan dibandingkan dengan NBD 5 mSv</span></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><template x-for="(q, idx) in getQuarterlyViewData()" :key="'mon-q-' + idx"><div class="bg-slate-800/60 rounded-lg p-3"><div class="flex justify-between text-xs mb-1"><span class="font-semibold" x-text="q.name"></span><span class="font-mono"><span x-text="q.total.toFixed(3)"></span> / 5 mSv</span></div><div class="flex items-center gap-3"><div class="flex-1"><div class="text-[10px] text-slate-400 mb-0.5">NBD 5 mSv</div><div class="h-2.5 bg-orange-900/20 rounded-full overflow-hidden"><div class="h-full bg-orange-500 w-full"></div></div></div><div class="flex-1"><div class="text-[10px] text-slate-400 mb-0.5">Progres (<span x-text="q.pct.toFixed(1)"></span>%)</div><div class="h-2.5 bg-slate-900 rounded-full overflow-hidden"><div class="h-full progress-bar rounded-full" :class="getBarColor(q.total, 5)" :style="'width: ' + Math.min(q.pct, 100) + '%'"></div></div></div></div><div class="flex justify-between items-center text-[11px] mt-1"><span class="text-slate-400">Status:</span><span class="px-2 py-0.5 rounded-full font-semibold" :class="getStatusFromValue(q.total, 5).badgeClass" x-text="getStatusFromValue(q.total, 5).label"></span></div></div></template></div></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6"><div class="bg-white rounded-2xl p-4 shadow-sm border flex flex-col"><h3 class="font-bold mb-1 text-sm">Dosis Bulanan vs NBD Bulanan</h3><div class="relative h-48"><canvas id="monthlyBarChartDashboard"></canvas></div></div><div class="bg-white rounded-2xl p-4 shadow-sm border flex flex-col"><h3 class="font-bold mb-1 text-sm">Tren Dosis Triwulan (Evaluasi TLD)</h3><div class="relative h-48"><canvas id="quarterLineChartDashboard"></canvas></div></div></div>
                    </div>
                </div>

                <div x-show="view === 'input'" class="no-print" x-transition.opacity>
                    <div class="max-w-4xl mx-auto space-y-4">
                        <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-slate-800">Data Pendose & Pembacaan</h2></div>
                        <template x-for="(month, mIndex) in activeMonths" :key="mIndex"><template x-if="month"><div class="bg-white rounded-lg border shadow-sm" :class="month.isOpen ? 'ring-1 ring-sky-500' : ''"><button @click="month.isOpen = !month.isOpen" class="w-full p-4 flex justify-between items-center bg-slate-50 hover:bg-slate-100 transition-colors"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded border flex items-center justify-center font-bold text-slate-500" x-text="mIndex + 1"></div><div class="flex items-center gap-3"><span class="font-bold text-lg" x-text="month.name"></span><div @click.stop class="relative"><select x-model="month.year" @change="saveData()" class="text-xs font-semibold bg-white border border-slate-300 rounded px-2 py-1 focus:ring-sky-500 focus:border-sky-500 cursor-pointer"><option value="2024">2024</option><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option><option value="2029">2029</option><option value="2030">2030</option></select></div></div></div><div class="flex items-center gap-4"><div x-show="month.total > 0" class="text-xs font-bold px-2 py-1 bg-sky-100 text-sky-700 rounded">Total: <span x-text="month.total.toFixed(3)"></span> mSv</div><i class="ph-bold ph-caret-down transition-transform duration-200" :class="month.isOpen && 'rotate-180'"></i></div></button><div x-show="month.isOpen" class="p-4 border-t" x-collapse><div class="grid grid-cols-12 gap-2 mb-2 text-xs uppercase font-semibold text-slate-500"><div class="col-span-2">Minggu</div><div class="col-span-3">Serial No</div><div class="col-span-2 text-center">Awal</div><div class="col-span-2 text-center">Akhir</div><div class="col-span-3 text-right">Dosis</div></div><template x-for="(week, wIndex) in month.weeks" :key="wIndex"><div class="grid grid-cols-12 gap-2 items-center mb-2"><div class="col-span-2 text-sm">Mg <span x-text="romanize(wIndex + 1)"></span></div><div class="col-span-3"><input type="text" x-model="week.serial" @change="saveData()" class="w-full bg-slate-50 border border-slate-200 rounded p-1.5 text-sm focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none"></div><div class="col-span-2"><input type="number" x-model.number="week.start" @input="calculate()" @change="saveData()" class="w-full text-center bg-slate-50 border border-slate-200 rounded p-1.5 text-sm focus:border-sky-500 outline-none" min="0" step="0.01"></div><div class="col-span-2"><input type="number" x-model.number="week.end" @input="calculate()" @change="saveData()" class="w-full text-center bg-slate-50 border border-slate-200 rounded p-1.5 text-sm focus:border-sky-500 outline-none" min="0" step="0.01"></div><div class="col-span-3 text-right font-mono font-bold text-sm" :class="week.mSv > 0.4 ? 'text-rose-500' : 'text-sky-600'"><span x-text="week.mSv > 0 ? week.mSv.toFixed(3) + ' mSv' : '-'"></span></div></div></template></div></div></template></template>
                        <div class="pt-6 border-t mt-4 text-center"><button @click="saveToHistoryAndReset()" class="inline-flex items-center gap-2 px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg transition-all transform hover:scale-105"><i class="ph ph-floppy-disk text-xl"></i> Simpan ke Riwayat & Reset Tahun Berikutnya</button><p class="text-xs text-slate-500 mt-2">Menyimpan data saat ini ke arsip dan mereset form untuk tahun depan.</p></div>
                    </div>
                </div>

                <div x-show="view === 'tld'" class="no-print" x-transition.opacity>
                    <div class="max-w-5xl mx-auto space-y-6">
                        <div class="bg-white rounded-2xl p-6 flex justify-between items-center shadow-sm border"><h2 class="text-lg font-bold">Total Dosis Tahunan (Data Pendose)</h2><div class="text-right"><div class="text-3xl font-mono font-bold text-sky-600"><span x-text="stats.year.toFixed(3)"></span> mSv</div><div class="text-xs uppercase mt-1 px-2 py-1 rounded inline-block" :class="stats.year > 20 ? 'bg-rose-100 text-rose-700' : 'bg-emerald-100 text-emerald-700'"><span x-text="getPercent(stats.year, 20).toFixed(2)"></span>% NBD</div></div></div>
                        <div class="bg-white rounded-2xl overflow-hidden shadow-sm border"><div class="p-6 bg-slate-50 border-b"><h3 class="font-bold">Evaluasi Dosis Triwulan (Input Manual)</h3><p class="text-xs text-slate-500 mt-1">Dosis triwulan dapat diisi manual.</p></div><table class="w-full text-left"><thead><tr class="text-xs uppercase bg-white border-b text-slate-500"><th class="p-6">Periode</th><th class="p-6">Cakupan (Bulan & Tahun)</th><th class="p-6 text-right">Dosis (mSv)</th><th class="p-6 text-right">% NBD</th><th class="p-6 text-center">Status</th></tr></thead><tbody class="divide-y text-sm"><template x-for="q in getQuarterlyViewData()" :key="q.index"><tr class="hover:bg-slate-50"><td class="p-6 font-medium" x-text="q.name"></td><td class="p-6 text-slate-500" x-text="q.fullLabel"></td><td class="p-6 text-right"><div class="flex flex-col items-end gap-1"><input type="number" step="0.001" min="0" class="w-28 text-right border rounded px-2 py-1 text-sm font-mono focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none" x-model.number="appData.quarterManualDose[activeWorkerId][q.index]" @change="saveData()" :placeholder="q.autoTotal.toFixed(3)"><span class="text-xs text-slate-400" x-show="q.hasManual">Otomatis: <span x-text="q.autoTotal.toFixed(3) + ' mSv'"></span></span></div></td><td class="p-6 text-right"><div class="flex items-center justify-end gap-2"><span class="w-12" x-text="q.pct.toFixed(1) + '%'"></span><div class="w-20 h-2 bg-slate-200 rounded-full"><div class="h-full rounded-full" :class="getBarColor(q.total, 5)" :style="'width: ' + Math.min(q.pct, 100) + '%'"></div></div></div></td><td class="p-6 text-center"><span class="px-3 py-1 rounded-full text-xs font-bold" :class="getStatusFromValue(q.total, 5).badgeClass" x-text="getStatusFromValue(q.total, 5).label"></span></td></tr></template></tbody><tfoot class="bg-slate-900 text-white"><tr><td class="p-6 font-bold" colspan="2">TOTAL</td><td class="p-6 text-right font-mono font-bold text-lg" x-text="getQuarterYearTotal().total.toFixed(3)"></td><td class="p-6 text-right font-bold" x-text="getQuarterYearTotal().pct.toFixed(1) + '%'"></td><td></td></tr></tfoot></table></div>
                        <div class="pt-2 text-center"><button @click="saveToHistoryAndReset()" class="inline-flex items-center gap-2 px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg transition-all transform hover:scale-105"><i class="ph ph-floppy-disk text-xl"></i> Simpan ke Riwayat & Reset Tahun Berikutnya</button></div>
                    </div>
                </div>

                <div x-show="view === 'history'" class="no-print" x-transition.opacity>
                    <div class="max-w-5xl mx-auto space-y-6">
                        <div class="bg-white rounded-2xl p-8 shadow-sm border">
                            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3"><i class="ph ph-clock-counter-clockwise text-sky-600"></i> Riwayat & Arsip</h2>
                            <template x-if="getArchivedData().length > 0">
                                <div class="grid gap-6">
                                    <template x-for="(archive, idx) in getArchivedData()" :key="idx">
                                        <div class="bg-white border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                            <div class="bg-slate-100 p-4 border-b flex justify-between items-center">
                                                <div>
                                                    <h3 class="font-bold text-lg text-slate-800" x-text="'Arsip Tahun ' + archive.year"></h3>
                                                    <span class="text-xs text-slate-500" x-text="new Date(archive.timestamp).toLocaleDateString() + ' ' + new Date(archive.timestamp).toLocaleTimeString()"></span>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button @click="openHistoryModal(archive, idx, 'view')" class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg flex items-center gap-1 text-xs font-bold"><i class="ph ph-eye text-lg"></i> Lihat</button>
                                                    <button @click="openHistoryModal(archive, idx, 'edit')" class="p-2 text-amber-600 hover:bg-amber-100 rounded-lg flex items-center gap-1 text-xs font-bold"><i class="ph ph-pencil-simple text-lg"></i> Edit</button>
                                                    <button @click="deleteHistoryItem(idx)" class="p-2 text-rose-600 hover:bg-rose-100 rounded-lg flex items-center gap-1 text-xs font-bold"><i class="ph ph-trash text-lg"></i> Hapus</button>
                                                </div>
                                            </div>
                                            <div class="p-4 grid md:grid-cols-2 gap-4">
                                                <div class="bg-sky-50 p-3 rounded-lg border border-sky-100"><h4 class="text-xs font-bold text-sky-800 mb-1">Total Pendose</h4><p class="text-xl font-mono text-sky-900" x-text="archive.totalDose.toFixed(3) + ' mSv'"></p></div>
                                                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100"><h4 class="text-xs font-bold text-indigo-800 mb-1">Total TLD</h4><p class="text-xl font-mono text-indigo-900" x-text="archive.totalTLD.toFixed(3) + ' mSv'"></p></div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <template x-if="getArchivedData().length === 0"><div class="text-center py-12 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200"><i class="ph ph-archive text-4xl text-slate-300 mb-2"></i><p class="text-slate-500">Belum ada data yang diarsipkan.</p></div></template>
                        </div>
                    </div>
                </div>

                <!-- LAPORAN -->
                <div x-show="view === 'report'" class="print-container">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-end gap-2 mb-4 no-print"><button @click="exportPdf()" class="btn-action bg-rose-500 text-white hover:bg-rose-600"><i class="ph ph-file-pdf"></i> PDF</button><button @click="exportJson()" class="btn-action bg-white border border-slate-300 hover:bg-slate-50"><i class="ph ph-download-simple"></i> JSON</button><button @click="window.print()" class="btn-action bg-sky-500 text-white hover:bg-sky-600"><i class="ph ph-printer"></i> Cetak</button></div>
                        <div class="bg-white rounded-2xl p-8 print-page" id="report-content">
                            <div class="break-inside-avoid">
                                <div class="mb-4 text-center"><template x-if="appData.settings.orgLogo"><img :src="appData.settings.orgLogo" class="mx-auto h-16 object-contain mb-2"></template><div class="font-bold text-lg" x-text="appData.settings.orgName || ''"></div></div>
                                <div class="mb-6 border-b pb-4"><h1 class="text-2xl font-bold text-center">Laporan Dosis Individu</h1></div>
                                <div class="grid grid-cols-2 gap-4 text-sm mb-6"><div class="space-y-1"><p><span class="font-semibold">Nama</span> : <span x-text="activeWorker?.name"></span></p><p><span class="font-semibold">ID</span> : <span x-text="activeWorker?.id_text"></span></p><p><span class="font-semibold">Area Kerja</span> : <span x-text="activeWorker?.area"></span></p></div><div class="text-right space-y-1"><p><span class="font-semibold">Total Dosis Tahun Ini</span> : <span class="font-mono" x-text="stats.year.toFixed(3) + ' mSv'"></span></p><p><span class="font-semibold">% NBD (20 mSv)</span> : <span x-text="getPercent(stats.year, 20).toFixed(1) + '%'"></span></p><p><span class="font-semibold">Periode</span> : Tahun Berjalan</p></div></div>
                            </div>
                            
                            <div class="mb-8 grid grid-cols-1 lg:grid-cols-2 print-grid-2 gap-4 break-inside-avoid">
                                <div class="border rounded-lg p-3"><div class="flex justify-between items-center mb-1"><h3 class="font-semibold text-sm">Dosis Bulanan (berdasarkan Pendose)</h3><span class="text-[10px] px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full font-medium">NBD per Bulan: 1.6 mSv</span></div><div class="relative h-40"><canvas id="monthlyBarChartReport"></canvas></div></div>
                                <div class="border rounded-lg p-3"><div class="flex justify-between items-center mb-1"><h3 class="font-semibold text-sm">Tren Triwulan (berdasarkan Evaluasi TLD)</h3><span class="text-[10px] px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded-full font-medium">NBD per Triwulan: 5 mSv</span></div><div class="relative h-40"><canvas id="quarterLineChartReport"></canvas></div></div>
                            </div>

                            <div class="mb-8">
                                <div class="flex justify-between items-center mb-3 break-inside-avoid"><h2 class="text-lg font-bold">1. Tabel Kumulatif</h2><div class="no-print flex gap-2"><select x-model="selectedReportMonth" x-show="reportTableMode === 'monthly'" class="text-sm border-gray-300 rounded-md shadow-sm bg-white"><template x-for="(m, i) in monthsList" :key="i"><option :value="i" x-text="m"></option></template></select><select x-model="reportTableMode" class="text-sm border-gray-300 rounded-md shadow-sm bg-white"><option value="yearly">Tahunan</option><option value="monthly">Perbulan</option></select></div></div>
                                <table class="w-full text-sm border border-slate-200">
                                    <thead class="bg-slate-50"><template x-if="reportTableMode === 'yearly'"><tr class="border-b border-slate-200 text-xs uppercase text-slate-500"><th class="p-2 text-left">Bulan / Tahun</th><th class="p-2 text-right">Dosis (mSv)</th><th class="p-2 text-right">Kumulatif</th><th class="p-2 text-right">% NBD</th><th class="p-2 text-center">Status</th></tr></template><template x-if="reportTableMode === 'monthly'"><tr class="border-b border-slate-200 text-xs uppercase text-slate-500"><th class="p-2 text-left">Bulan / Tahun</th><th class="p-2 text-right">Mg I</th><th class="p-2 text-right">Mg II</th><th class="p-2 text-right">Mg III</th><th class="p-2 text-right">Mg IV</th><th class="p-2 text-right font-bold">Total</th></tr></template></thead>
                                    <tbody><template x-if="reportTableMode === 'yearly'"><template x-for="m in getMonthlyCumulative()" :key="m.index"><tr class="border-t border-slate-100"><td class="p-2"><span x-text="m.name"></span> <span class="text-xs text-slate-400" x-text="m.year"></span></td><td class="p-2 text-right font-mono" x-text="m.monthly.toFixed(3)"></td><td class="p-2 text-right font-mono font-semibold" x-text="m.cumulative.toFixed(3)"></td><td class="p-2 text-right" x-text="m.pct.toFixed(1) + '%'"></td><td class="p-2 text-center"><span class="px-2 py-0.5 rounded-full text-xs font-bold" :class="getStatusFromValue(m.monthly, MONTHLY_NBD).badgeClass" x-text="getStatusFromValue(m.monthly, MONTHLY_NBD).label"></span></td></tr></template></template><template x-if="reportTableMode === 'monthly' && activeMonths && activeMonths[selectedReportMonth]"><tr class="border-t border-slate-100"><td class="p-2"><span x-text="activeMonths[selectedReportMonth].name"></span> <span class="text-xs text-slate-400" x-text="activeMonths[selectedReportMonth].year"></span></td><template x-for="(w, wIdx) in activeMonths[selectedReportMonth].weeks" :key="wIdx"><td class="p-2 text-right font-mono text-xs text-slate-600" x-text="w.mSv > 0 ? w.mSv.toFixed(3) : '-'"></td></template><td class="p-2 text-right font-mono font-bold" x-text="(activeMonths[selectedReportMonth].total || 0).toFixed(3)"></td></tr></template></tbody>
                                    <template x-if="reportTableMode === 'yearly'"><tfoot class="bg-slate-900 text-white"><tr><td class="p-2 font-bold">TOTAL</td><td class="p-2 text-right font-mono font-bold" x-text="stats.year.toFixed(3)"></td><td colspan="3"></td></tr></tfoot></template><template x-if="reportTableMode === 'monthly' && activeMonths && activeMonths[selectedReportMonth]"><tfoot class="bg-slate-900 text-white"><tr><td class="p-2 font-bold" colspan="5">TOTAL BULAN INI</td><td class="p-2 text-right font-mono font-bold" x-text="(activeMonths[selectedReportMonth].total || 0).toFixed(3)"></td></tr></tfoot></template>
                                </table>
                            </div>

                            <div class="mb-8 break-inside-avoid"><h2 class="text-lg font-bold mb-3">2. Tabel Evaluasi TLD (Triwulan)</h2><table class="w-full text-sm border border-slate-200"><thead class="bg-slate-50"><tr class="border-b border-slate-200 text-xs uppercase text-slate-500"><th class="p-2 text-left">Periode</th><th class="p-2 text-left">Cakupan</th><th class="p-2 text-right">Dosis (mSv)</th><th class="p-2 text-right">% NBD</th><th class="p-2 text-center">Status</th></tr></thead><tbody><template x-for="q in getQuarterlyViewData()" :key="q.index"><tr class="border-t border-slate-100"><td class="p-2 font-medium" x-text="q.name"></td><td class="p-2 text-slate-500 text-xs" x-text="q.fullLabel"></td><td class="p-2 text-right font-mono font-semibold" x-text="q.total.toFixed(3)"></td><td class="p-2 text-right" x-text="q.pct.toFixed(1) + '%'"></td><td class="p-2 text-center"><span class="px-3 py-1 rounded-full text-xs font-bold" :class="getStatusFromValue(q.total, 5).badgeClass" x-text="getStatusFromValue(q.total, 5).label"></span></td></tr></template></tbody><tfoot class="bg-slate-900 text-white"><tr><td class="p-6 font-bold" colspan="2">TOTAL</td><td class="p-6 text-right font-mono font-bold text-lg" x-text="getQuarterYearTotal().total.toFixed(3)"></td><td class="p-6 text-right font-bold" x-text="getQuarterYearTotal().pct.toFixed(1) + '%'"></td><td></td></tr></tfoot></table></div>
                            <div class="mb-8 break-inside-avoid"><h2 class="text-lg font-bold mb-3">3. Kesimpulan</h2><div class="p-4 border rounded-lg bg-slate-50 text-sm"><p>Status paparan pekerja: <span class="font-bold" :class="getConclusion().color" x-text="getConclusion().status"></span></p><p class="mt-2 text-slate-600" x-text="getConclusion().note"></p></div></div>
                            <div class="mt-10 flex justify-end break-inside-avoid"><div class="text-center w-48"><p class="text-sm">Petugas Proteksi Radiasi (PPR)</p><p class="mt-8 font-semibold" x-text="appData.settings.pprName || ''"></p><div class="mt-1 border-t border-slate-400"></div><p class="mt-1 text-xs" x-show="appData.settings.pprNib">No. SIB: <span x-text="appData.settings.pprNib"></span></p></div></div>
                        </div>
                    </div>
                </div>

                <div x-show="view === 'settings'" class="no-print" x-transition.opacity>
                    <div class="max-w-4xl mx-auto space-y-8">
                        <div class="bg-white rounded-xl shadow-sm border"><div class="p-6 border-b"><h2 class="text-lg font-bold">Manajemen Pekerja</h2></div><div class="p-6 space-y-3"><template x-for="worker in appData.workers" :key="worker.id"><div class="flex items-center gap-4 p-2 bg-slate-50 rounded-lg"><div class="flex-1 grid grid-cols-3 gap-4"><input type="text" x-model="worker.name" @change="saveData()" class="w-full p-2 border rounded"><input type="text" x-model="worker.id_text" @change="saveData()" class="w-full p-2 border rounded"><input type="text" x-model="worker.area" @change="saveData()" class="w-full p-2 border rounded"></div><button @click="deleteWorker(worker.id)" class="p-2 text-rose-500 hover:bg-rose-100 rounded-full"><i class="ph ph-trash text-lg"></i></button></div></template></div><div class="p-6 border-t bg-slate-50"><h3 class="font-bold mb-2">Tambah Pekerja Baru</h3><div class="flex items-center gap-4"><input type="text" x-model="newWorkerName" @keydown.enter="addWorker()" placeholder="Ketik nama pekerja baru..." class="flex-1 p-2 border rounded-lg"><button @click="addWorker()" class="px-5 py-2 bg-sky-600 text-white rounded-lg font-medium">Tambah</button></div></div></div>
                        <div class="bg-white rounded-xl shadow-sm border"><div class="p-6 border-b"><h2 class="text-lg font-bold">Identitas Organisasi & Laporan</h2></div><div class="p-6 space-y-4"><div><label class="block text-sm font-medium mb-1">Nama Organisasi</label><input type="text" x-model="appData.settings.orgName" @change="saveData()" class="w-full p-2 border rounded-lg"></div><div class="space-y-2"><label class="block text-sm font-medium mb-1">Logo Organisasi (200 x 145 px disarankan)</label><input type="file" accept="image/*" x-ref="logoFileInput" @change="handleLogoFileChange($event)" class="block w-full text-sm text-slate-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100"><p class="text-xs text-slate-500">Pilih file logo...</p></div><div x-show="appData.settings.orgLogo" x-cloak class="pt-2 space-y-2"><div class="w-[200px] h-[120px] border rounded flex items-center justify-center bg-slate-50"><img :src="appData.settings.orgLogo" class="max-w-full max-h-full object-contain"></div><button type="button" @click="clearLogo()" class="inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-rose-50 text-rose-600 hover:bg-rose-100 border border-rose-200">Hapus Logo</button></div><div><label class="block text-sm font-medium mb-1">Nama Petugas (PPR)</label><input type="text" x-model="appData.settings.pprName" @change="saveData()" class="w-full p-2 border rounded-lg"></div><div><label class="block text-sm font-medium mb-1">Nomor SIB PPR</label><input type="text" x-model="appData.settings.pprNib" @change="saveData()" class="w-full p-2 border rounded-lg"></div></div></div>
                        <template x-if="activeWorker"><div class="bg-white rounded-xl shadow-sm border"><div class="p-6 border-b"><h2 class="text-lg font-bold">Pengaturan Periode Triwulan (<span class="text-sky-600" x-text="activeWorker.name"></span>)</h2></div><div class="p-6 space-y-4"><template x-if="activeWorker.quarters"><div><template x-for="(quarter, index) in activeWorker.quarters" :key="index"><div class="flex flex-col md:flex-row items-start md:items-center gap-2 p-3 bg-slate-50 rounded-lg border mb-2"><div class="w-24 font-bold text-sm" x-text="`Triwulan ${romanize(index + 1)}`"></div><div class="flex items-center gap-1"><select x-model.number="quarter.start" @change="saveData()" class="w-24 p-2 border rounded text-sm bg-white"><template x-for="(month, idx) in monthsList" :key="idx"><option :value="idx" x-text="month"></option></template></select><select x-model="quarter.startYear" @change="saveData()" class="w-20 p-2 border rounded text-sm bg-white font-mono"><option value="2024">2024</option><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option><option value="2029">2029</option><option value="2030">2030</option></select></div><span class="text-sm text-slate-400">s/d</span><div class="flex items-center gap-1"><select x-model.number="quarter.end" @change="saveData()" class="w-24 p-2 border rounded text-sm bg-white"><template x-for="(month, idx) in monthsList" :key="idx"><option :value="idx" x-text="month"></option></template></select><select x-model="quarter.endYear" @change="saveData()" class="w-20 p-2 border rounded text-sm bg-white font-mono"><option value="2024">2024</option><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option><option value="2029">2029</option><option value="2030">2030</option></select></div><button @click="removeQuarter(index)" class="ml-auto p-2 text-rose-500 hover:bg-rose-100 rounded-full" title="Hapus Periode"><i class="ph ph-trash"></i></button></div></template></div></template><div class="pt-2"><button @click="addQuarter()" class="flex items-center gap-2 px-4 py-2 bg-sky-50 text-sky-600 rounded-lg border border-sky-200 hover:bg-sky-100 text-sm font-medium transition-colors"><i class="ph ph-plus-circle text-lg"></i> Tambah Periode</button></div></div></div></template>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        const API_KEY = '$2a$10$hF1ZR5kW/k4jOtMauqXfX.w2asr.Mu74rBN84X8.rA3FBNZyU.uNm';
        const BIN_ID = '6937d036d0ea881f401c6035';
        const BIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}/latest`;

        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        const MONTHLY_NBD = 1.6;
        const QUARTER_NBD = 5.0;
        const defaultQuarters = [
            { start: 0, startYear: 2024, end: 2, endYear: 2024 }, 
            { start: 3, startYear: 2024, end: 5, endYear: 2024 }, 
            { start: 6, startYear: 2024, end: 8, endYear: 2024 }, 
            { start: 9, startYear: 2024, end: 11, endYear: 2024 }
        ];
        
        function createYearData() {
            return monthNames.map(name => ({ name, year: 2024, isOpen: false, total: 0, weeks: Array.from({ length: 4 }, () => ({ serial: '', start: null, end: null, mSv: 0 })) }));
        }

        function createYearDataWithYear(year) {
            return monthNames.map(name => ({ name, year: year, isOpen: false, total: 0, weeks: Array.from({ length: 4 }, () => ({ serial: '', start: null, end: null, mSv: 0 })) }));
        }

        function radGuardApp() {
            return {
                sidebarOpen: true,
                view: 'dashboard',
                screenReaderMessage: '',
                isLoading: true,
                isSaving: false,
                loadingMessage: 'Memuat Data...',
                appData: { workers: [], doseData: {}, settings: {}, quarterManualDose: {}, archivedData: {} },
                activeWorkerId: null,
                newWorkerName: '',
                reportTableMode: 'yearly',
                selectedReportMonth: 0, 
                monthsList: monthNames,
                historyModalOpen: false, 
                historyMode: 'view', 
                tempArchiveData: null, 
                tempArchiveIndex: null, 
                isPrintingModal: false, 
                stats: { year: 0, maxMonth: 0, maxWeek: 0, quarter: 0 },
                monthlyChartDashboard: null, quarterlyChartDashboard: null, monthlyChartReport: null, quarterlyChartReport: null,

                async initApp() {
                    this.sidebarOpen = window.innerWidth >= 1024;
                    await this.loadData();
                    this.initCharts();
                    this.$watch('activeWorkerId', () => this.onWorkerChange());
                    this.$watch('view', (v) => { if (v === 'dashboard' || v === 'report') { this.$nextTick(() => this.updateAllCharts()); } });
                    this.setupForActiveWorker();
                    this.isLoading = false;
                },
                
                async loadData() {
                    this.isLoading = true;
                    try {
                        const response = await fetch(`${BIN_URL}/latest`, { method: 'GET', headers: { 'X-Master-Key': API_KEY } });
                        if (!response.ok) throw new Error('Fetch failed');
                        const data = await response.json();
                        this.appData = data.record || {};
                        if (this.appData.workers && this.appData.workers.length > 0) {
                            this.activeWorkerId = this.appData.workers[0].id;
                        } else {
                            this.createDefaultData();
                        }
                    } catch (e) {
                        console.error(e);
                        this.createDefaultData();
                    } finally {
                        this.isLoading = false;
                    }
                },

                async saveData() {
                    if (this.isSaving) return;
                    this.isSaving = true;
                    try {
                        await fetch(BIN_URL, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY }, body: JSON.stringify(this.appData) });
                    } catch (e) {
                        alert('Gagal menyimpan data.');
                    } finally {
                        setTimeout(() => { this.isSaving = false; }, 500);
                    }
                },

                createDefaultData() {
                    const defaultId = Date.now();
                    this.appData = { 
                        workers: [{ id: defaultId, name: 'Candra Adijaya', id_text: 'RAD-001', area: 'Maruwai Coal', quarters: JSON.parse(JSON.stringify(defaultQuarters)) }], 
                        doseData: { [defaultId]: createYearData() }, 
                        quarterManualDose: { [defaultId]: [null, null, null, null] }, 
                        archivedData: { [defaultId]: [] },
                        settings: { reportStatusMode: 'auto', orgName: 'Nama Organisasi' } 
                    };
                    this.activeWorkerId = defaultId;
                    this.saveData();
                },

                get activeWorker() { return this.appData.workers?.find(w => w.id === this.activeWorkerId); },
                get activeMonths() { return this.appData.doseData?.[this.activeWorkerId] || []; },
                switchView(view) { this.view = view; },
                
                getArchivedData() {
                    if (!this.activeWorkerId || !this.appData.archivedData) return [];
                    return this.appData.archivedData[this.activeWorkerId] || [];
                },

                getArchivePeriodLabel(idx) {
                    if (!this.tempArchiveData || !this.tempArchiveData.quarters) {
                        const sIdx = idx * 3; 
                        const eIdx = (idx * 3) + 2;
                        const yr = this.tempArchiveData ? this.tempArchiveData.year : 2024;
                        return `${monthNames[sIdx]} ${yr} s/d ${monthNames[eIdx]} ${yr}`;
                    }
                    
                    const q = this.tempArchiveData.quarters[idx];
                    if (!q) return '-';
                    const sName = monthNames[q.start] || 'Januari';
                    const eName = monthNames[q.end] || 'Januari';
                    const sYear = q.startYear || this.tempArchiveData.year;
                    const eYear = q.endYear || this.tempArchiveData.year;
                    return `${sName} ${sYear} s/d ${eName} ${eYear}`;
                },

                saveToHistoryAndReset() {
                    if (!confirm("Apakah Anda yakin ingin menyimpan data tahun ini ke riwayat dan mereset form untuk tahun berikutnya?")) return;
                    const wId = this.activeWorkerId;
                    if (!this.appData.archivedData) this.appData.archivedData = {};
                    if (!this.appData.archivedData[wId]) this.appData.archivedData[wId] = [];

                    const currentDoseData = JSON.parse(JSON.stringify(this.appData.doseData[wId]));
                    const currentTLDData = JSON.parse(JSON.stringify(this.appData.quarterManualDose[wId]));
                    const currentYear = currentDoseData[0].year || 2024;
                    const currentQuarters = JSON.parse(JSON.stringify(this.activeWorker.quarters || defaultQuarters));

                    let totalPendose = 0;
                    currentDoseData.forEach(m => totalPendose += (m.total || 0));
                    
                    let totalTLD = 0;
                    if(this.getQuarterYearTotal) {
                        totalTLD = this.getQuarterYearTotal().total;
                    }

                    this.appData.archivedData[wId].push({
                        year: currentYear,
                        doseData: currentDoseData,
                        quarterManualDose: currentTLDData,
                        quarters: currentQuarters, 
                        totalDose: totalPendose,
                        totalTLD: totalTLD,
                        timestamp: new Date().toISOString()
                    });

                    const nextYear = parseInt(currentYear) + 1;
                    this.appData.doseData[wId] = createYearDataWithYear(nextYear);
                    this.appData.quarterManualDose[wId] = []; 

                    if (this.activeWorker.quarters) {
                        this.activeWorker.quarters.forEach(q => {
                            q.startYear = nextYear;
                            q.endYear = nextYear;
                        });
                    }

                    this.saveData().then(() => {
                        alert(`Data Tahun ${currentYear} berhasil diarsipkan.`);
                        this.setupForActiveWorker();
                        this.switchView('history');
                    });
                },

                openHistoryModal(archive, index, mode) {
                    this.historyMode = mode;
                    this.tempArchiveIndex = index;
                    this.tempArchiveData = JSON.parse(JSON.stringify(archive));
                    if(!this.tempArchiveData.quarterManualDose) this.tempArchiveData.quarterManualDose = [null,null,null,null];
                    this.historyModalOpen = true;
                },

                calculateTempMonthTotal(m) {
                    let sum = 0;
                    m.weeks.forEach(w => {
                        const start = parseFloat(w.start);
                        const end = parseFloat(w.end);
                        const val = (!isNaN(start) && !isNaN(end)) ? Math.max(0, end - start) * 0.01 : 0;
                        w.mSv = val;
                        sum += val;
                    });
                    return sum;
                },

                saveHistoryChanges() {
                    if (this.tempArchiveIndex === null || !this.tempArchiveData) return;
                    
                    let newTotalDose = 0;
                    this.tempArchiveData.doseData.forEach(m => {
                        let mSum = 0;
                        m.weeks.forEach(w => {
                            const start = parseFloat(w.start);
                            const end = parseFloat(w.end);
                            const val = (!isNaN(start) && !isNaN(end)) ? Math.max(0, end - start) * 0.01 : 0;
                            w.mSv = val;
                            mSum += val;
                        });
                        m.total = mSum;
                        newTotalDose += mSum;
                    });
                    this.tempArchiveData.totalDose = newTotalDose;

                    const wId = this.activeWorkerId;
                    this.appData.archivedData[wId][this.tempArchiveIndex] = this.tempArchiveData;
                    
                    this.saveData().then(() => {
                        alert("Perubahan arsip berhasil disimpan.");
                        this.historyModalOpen = false;
                    });
                },

                deleteHistoryItem(index) {
                    if(confirm("Yakin ingin menghapus arsip ini secara permanen?")) {
                        const wId = this.activeWorkerId;
                        this.appData.archivedData[wId].splice(index, 1);
                        this.saveData();
                    }
                },

                async printModal() {
                    this.isPrintingModal = true;
                    await new Promise(r => setTimeout(r, 100));
                    window.print();
                    this.isPrintingModal = false;
                },

                handleLogoFileChange(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    if (file.size > 2 * 1024 * 1024) { alert('File terlalu besar (Max 2MB)'); return; }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.appData.settings.orgLogo = e.target.result;
                        this.saveData();
                    };
                    reader.readAsDataURL(file);
                },
                clearLogo() {
                    this.appData.settings.orgLogo = '';
                    this.saveData();
                    if(this.$refs.logoFileInput) this.$refs.logoFileInput.value = '';
                },

                addWorker() { if (!this.newWorkerName.trim()) return; const newId = Date.now(); this.appData.workers.push({ id: newId, name: this.newWorkerName.trim(), id_text: `RAD-${String(newId).slice(-3)}`, area: 'Default Area', quarters: JSON.parse(JSON.stringify(defaultQuarters)) }); this.appData.doseData[newId] = createYearData(); this.appData.quarterManualDose[newId] = [null, null, null, null]; this.activeWorkerId = newId; this.newWorkerName = ''; this.saveData(); },
                deleteWorker(id) { if (this.appData.workers.length <= 1) return; if (confirm('Hapus pekerja?')) { this.appData.workers = this.appData.workers.filter(w => w.id !== id); delete this.appData.doseData[id]; delete this.appData.quarterManualDose[id]; this.activeWorkerId = this.appData.workers[0].id; this.saveData(); } },
                
                addQuarter() {
                    if (!this.activeWorker) return;
                    if (!this.activeWorker.quarters) this.activeWorker.quarters = [];
                    this.activeWorker.quarters.push({ start: 0, startYear: 2024, end: 2, endYear: 2024 });
                    this.saveData();
                },
                removeQuarter(index) {
                    if (!this.activeWorker) return;
                    if (confirm("Hapus periode triwulan ini?")) {
                        this.activeWorker.quarters.splice(index, 1);
                        this.saveData();
                    }
                },

                onWorkerChange() { this.setupForActiveWorker(); },
                
                setupForActiveWorker() { 
                    if (!this.activeWorkerId) return; 
                    
                    if (!this.appData.doseData) this.appData.doseData = {};
                    let currentData = this.appData.doseData[this.activeWorkerId];

                    if (!currentData || !Array.isArray(currentData) || currentData.length !== 12 || currentData.includes(null) || currentData.includes(undefined)) {
                        const freshData = createYearData(); 
                        if (Array.isArray(currentData)) {
                            currentData.forEach((oldM, idx) => {
                                if (oldM && freshData[idx]) {
                                    freshData[idx].total = oldM.total || 0;
                                    freshData[idx].weeks = oldM.weeks || freshData[idx].weeks;
                                    freshData[idx].year = oldM.year || 2024;
                                }
                            });
                        }
                        this.appData.doseData[this.activeWorkerId] = freshData;
                        this.saveData(); 
                    }

                    if (!this.appData.quarterManualDose[this.activeWorkerId]) {
                        this.appData.quarterManualDose[this.activeWorkerId] = [];
                    }

                    if (this.activeWorker && !this.activeWorker.quarters) {
                        this.activeWorker.quarters = JSON.parse(JSON.stringify(defaultQuarters));
                    }
                    
                    if (this.activeWorker && this.activeWorker.quarters) {
                         this.activeWorker.quarters.forEach(q => {
                             if (!q.startYear) q.startYear = 2024;
                             if (!q.endYear) q.endYear = 2024;
                             if (q.end > 11) q.end = 11; 
                             if (q.start > 11) q.start = 0;
                         });
                    }
                    
                    this.calculate(); 
                },
                
                calculate() {
                    if (!this.activeMonths || !Array.isArray(this.activeMonths)) return;
                    let ySum = 0; 
                    this.activeMonths.forEach(m => { 
                        if (m) { 
                            let mSum = 0; 
                            if(m.weeks && Array.isArray(m.weeks)) {
                                m.weeks.forEach(w => { 
                                    w.mSv = (!isNaN(parseFloat(w.start)) && !isNaN(parseFloat(w.end))) ? Math.max(0, w.end - w.start) * 0.01 : 0; 
                                    mSum += w.mSv; 
                                }); 
                            }
                            m.total = mSum; ySum += mSum; 
                        }
                    });
                    this.stats.year = ySum;
                    if(this.monthlyChartDashboard) this.updateAllCharts();
                },
                
                getQuarterlyViewData() { 
                    if (!this.activeWorker?.quarters || !this.activeMonths || !this.activeMonths.length) return []; 
                    const quarters = this.activeWorker.quarters;
                    const manualArr = this.appData.quarterManualDose[this.activeWorkerId] || []; 
                    
                    return quarters.map((q, index) => { 
                        let autoTotal = 0; 
                        
                        const startIdx = q.start || 0;
                        const endIdx = q.end || 0;
                        const sYear = parseInt(q.startYear || 2024);
                        const eYear = parseInt(q.endYear || 2024);

                        const rangeStart = (sYear * 12) + startIdx;
                        const rangeEnd = (eYear * 12) + endIdx;

                        this.activeMonths.forEach((m, mIdx) => {
                            if(m) {
                                const mYear = parseInt(m.year || 2024);
                                const mAbs = (mYear * 12) + mIdx;
                                if (mAbs >= rangeStart && mAbs <= rangeEnd) {
                                    autoTotal += (m.total || 0);
                                }
                            }
                        });
                        
                        const sName = monthNames[startIdx] || 'Januari';
                        const eName = monthNames[endIdx] || 'Januari';
                        let fullLabel = `${sName} ${sYear} s/d ${eName} ${eYear}`;

                        let mVal = parseFloat(manualArr[index]); 
                        const total = (!isNaN(mVal) && mVal >= 0) ? mVal : autoTotal; 
                        return { index, name: `Triwulan ${this.romanize(index + 1)}`, fullLabel, autoTotal, total, pct: (total / QUARTER_NBD) * 100, hasManual: !isNaN(mVal) }; 
                    }); 
                },
                
                getMonthlyCumulative() { 
                    if (!this.activeMonths) return [];
                    let cum = 0; 
                    return this.activeMonths.filter(m => m).map((m, idx) => { 
                        cum += (m.total || 0); 
                        return { index: idx + 1, name: m.name, year: m.year || 2024, monthly: m.total || 0, cumulative: cum, pct: (cum / 20) * 100 }; 
                    }); 
                },

                getQuarterYearTotal() { const qs = this.getQuarterlyViewData(); const total = qs.reduce((sum, q) => sum + q.total, 0); return { total, pct: (total / 20) * 100 }; },
                getConclusion() { const pct = (this.stats.year / 20) * 100; if (pct > 75) return { status: 'Bahaya', note: 'Melebihi 75% NBD.', color: 'text-rose-600' }; if (pct >= 25) return { status: 'Waspada', note: 'Antara 25-75% NBD.', color: 'text-amber-600' }; return { status: 'Aman', note: 'Dibawah 25% NBD.', color: 'text-emerald-600' }; },
                getInitials(n) { return n ? n.split(' ').map(x=>x[0]).join('').substring(0,2).toUpperCase() : ''; },
                romanize(n) { return ['I','II','III','IV','V','VI','VII'][n-1] || n; },
                getPercent(v, m) { return m > 0 ? (v / m) * 100 : 0; },
                getBarColor(v, m) { const p = (v/m)*100; return p > 75 ? 'bg-rose-500' : p >= 25 ? 'bg-amber-500' : 'bg-emerald-500'; },
                getStatusFromValue(v, m) { const p = (v/m)*100; return p > 75 ? {label:'Bahaya', badgeClass:'bg-rose-100 text-rose-600'} : p >= 25 ? {label:'Waspada', badgeClass:'bg-amber-100 text-amber-700'} : {label:'Aman', badgeClass:'bg-emerald-100 text-emerald-700'}; },
                
                exportJson() { const b = new Blob([JSON.stringify(this.appData,null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `radguard-${new Date().toISOString().slice(0,10)}.json`; a.click(); },
                async exportPdf() { this.isLoading = true; await new Promise(r=>setTimeout(r,500)); window.print(); this.isLoading = false; }, 
                
                initCharts() { 
                    const chartOpts = { responsive: true, maintainAspectRatio: false, legend: { display: false }, scales: { yAxes: [{ ticks: { beginAtZero: true } }] } };
                    ['Dashboard', 'Report'].forEach(s => {
                        const bc = document.getElementById(`monthlyBarChart${s}`);
                        if(bc) this[`monthlyChart${s}`] = new Chart(bc.getContext('2d'), { 
                            type: 'bar', 
                            data: { 
                                labels: monthNames.map(m=>m.slice(0,3)), 
                                datasets: [
                                    { label: 'Dosis', data: [], backgroundColor: '#38bdf8' },
                                    { label: 'NBD (1.6)', data: [], backgroundColor: '#f97316' }
                                ] 
                            }, 
                            options: chartOpts 
                        });
                        const lc = document.getElementById(`quarterLineChart${s}`);
                        if(lc) this[`quarterlyChart${s}`] = new Chart(lc.getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'Dosis', data: [], borderColor: '#6366f1', fill: false }] }, options: chartOpts });
                    });
                    this.updateAllCharts();
                },
                updateAllCharts() {
                    if (!this.activeWorker || !this.activeMonths) return;
                    const mData = this.activeMonths.map(m => m ? m.total : 0);
                    const qView = this.getQuarterlyViewData();
                    const qLabels = qView.map(q => q.name);
                    const qData = qView.map(q => q.total);
                    [this.monthlyChartDashboard, this.monthlyChartReport].forEach(c => { 
                        if(c) { 
                            c.data.datasets[0].data = mData; 
                            c.data.datasets[1].data = Array(mData.length).fill(MONTHLY_NBD);
                            c.update(); 
                        } 
                    });
                    [this.quarterlyChartDashboard, this.quarterlyChartReport].forEach(c => { if(c) { c.data.labels = qLabels; c.data.datasets[0].data = qData; c.update(); } });
                }
            }
        }
    </script>
    <style>.btn-action { @apply inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium border transition-colors; }</style>
</body>
</html>